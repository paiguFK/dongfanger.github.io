

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>13 Python函数装饰器高级用法 &mdash; 自动化代码美学 latest documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/js/readmore.js"></script>
        <script src="../_static/js/baidutongji.js"></script>
        <script src="../_static/js/valine.js"></script>
        <script src="../_static/js/Valine.min.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="14 Python字符与字节新编" href="014-Python%E5%AD%97%E7%AC%A6%E4%B8%8E%E5%AD%97%E8%8A%82%E6%96%B0%E7%BC%96.html" />
    <link rel="prev" title="12 关于Python闭包的一切" href="012-%E5%85%B3%E4%BA%8EPython%E9%97%AD%E5%8C%85%E7%9A%84%E4%B8%80%E5%88%87.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> 自动化代码美学
          

          
          </a>

          
            
            
              <div class="version">
                latest
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../preface.html">前言</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/Java%E5%85%A5%E9%97%A8.html">Java入门</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/JMeter.html">JMeter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/juice%E6%95%88%E7%8E%87%E5%B7%A5%E5%85%B7%E5%B9%B3%E5%8F%B0.html">juice效率工具平台</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/Python%E5%85%A5%E9%97%A8.html">Python入门</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../chapters/Python%E8%BF%9B%E9%98%B6.html">Python进阶</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="001-%E9%AD%94%E6%B3%95%E6%96%B9%E6%B3%95%E6%8E%A8%E5%BC%80Python%E8%BF%9B%E9%98%B6%E5%AD%A6%E4%B9%A0%E5%A4%A7%E9%97%A8.html">1 魔法方法推开Python进阶学习大门</a></li>
<li class="toctree-l2"><a class="reference internal" href="002-Python%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%E4%B8%8EPython%E5%AF%B9%E8%B1%A1%E6%A8%A1%E5%9E%8B.html">2 Python数据模型与Python对象模型</a></li>
<li class="toctree-l2"><a class="reference internal" href="003-Python%E5%85%83%E7%BB%84%E6%8B%86%E5%8C%85%E6%8D%A1%E5%88%B08%E5%80%8D%E9%95%9C%E5%BF%AB%E5%87%86%E7%8B%A0.html">3 Python元组拆包捡到8倍镜快准狠</a></li>
<li class="toctree-l2"><a class="reference internal" href="004-%E8%83%BD%E5%8F%96%E5%80%BC%E4%BA%A6%E8%83%BD%E8%B5%8B%E5%80%BC%E7%9A%84Python%E5%88%87%E7%89%87.html">4 能取值亦能赋值的Python切片</a></li>
<li class="toctree-l2"><a class="reference internal" href="005-%E5%BA%8F%E5%88%97%E8%B5%8B%E5%80%BC%E5%BC%95%E5%8F%91%E7%9A%84Python%E5%88%97%E8%A1%A8%E9%99%B7%E8%BF%9B.html">5 序列赋值引发的Python列表陷进</a></li>
<li class="toctree-l2"><a class="reference internal" href="006-%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90Python%E5%AD%97%E5%85%B8%E5%92%8C%E9%9B%86%E5%90%88%EF%BC%88%E4%B8%8A%EF%BC%89.html">6 深度剖析Python字典和集合（上）</a></li>
<li class="toctree-l2"><a class="reference internal" href="007-%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90Python%E5%AD%97%E5%85%B8%E5%92%8C%E9%9B%86%E5%90%88%EF%BC%88%E4%B8%8B%EF%BC%89.html">7 深度剖析Python字典和集合（下）</a></li>
<li class="toctree-l2"><a class="reference internal" href="008-%E5%8E%9F%E6%9D%A5Python%E5%87%BD%E6%95%B0%E5%8F%AA%E6%98%AF%E4%B8%AA%E5%AF%B9%E8%B1%A1.html">8 原来Python函数只是个对象</a></li>
<li class="toctree-l2"><a class="reference internal" href="009-Python%E5%87%BD%E6%95%B0%E5%8F%82%E6%95%B0%E5%92%8C%E6%B3%A8%E8%A7%A3%E6%98%AF%E4%BB%80%E4%B9%88.html">9 Python函数参数和注解是什么</a></li>
<li class="toctree-l2"><a class="reference internal" href="010-Python%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E7%9F%A5%E5%A4%9A%E5%B0%91.html">10 Python设计模式知多少</a></li>
<li class="toctree-l2"><a class="reference internal" href="011-Python%E5%87%BD%E6%95%B0%E8%A3%85%E9%A5%B0%E5%99%A8%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86.html">11 Python函数装饰器基础知识</a></li>
<li class="toctree-l2"><a class="reference internal" href="012-%E5%85%B3%E4%BA%8EPython%E9%97%AD%E5%8C%85%E7%9A%84%E4%B8%80%E5%88%87.html">12 关于Python闭包的一切</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">13 Python函数装饰器高级用法</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">典型的函数装饰器</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">叠放装饰器</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">参数化装饰器</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">标准库中的装饰器</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#functools-wraps">functools.wraps</a></li>
<li class="toctree-l4"><a class="reference internal" href="#functools-lru-cache">functools.lru_cache</a></li>
<li class="toctree-l4"><a class="reference internal" href="#functools-singledispatch">functools.singledispatch</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id5">小结</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="014-Python%E5%AD%97%E7%AC%A6%E4%B8%8E%E5%AD%97%E8%8A%82%E6%96%B0%E7%BC%96.html">14 Python字符与字节新编</a></li>
<li class="toctree-l2"><a class="reference internal" href="999-%E6%B5%81%E7%95%85%E7%9A%84python%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0.html">999 流畅的python读书笔记</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/pytest%E5%8E%9F%E7%94%9F%E6%A1%86%E6%9E%B6.html">pytest原生框架</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/tep%E5%BC%80%E6%BA%90%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7.html">tep开源测试工具</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/teprunner%E5%BC%80%E6%BA%90%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0.html">teprunner开源测试平台</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/Django.html">Django</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/Django%20REST%20framework.html">Django REST framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/Locust.html">Locust</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/%E5%A4%A7%E6%9D%82%E7%83%A9.html">大杂烩</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/%E5%B9%B4%E5%BA%A6%E6%80%BB%E7%BB%93.html">年度总结</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/%E6%88%90%E9%95%BF%E5%B0%8F%E8%AF%B4.html">成长小说</a></li>
<li class="toctree-l1"><a class="reference internal" href="../question.html">面试题库</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aboutme.html">关于作者</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contact.html">联系方式</a></li>
<li class="toctree-l1"><a class="reference internal" href="../link.html">友情链接</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">自动化代码美学</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../chapters/Python%E8%BF%9B%E9%98%B6.html">Python进阶</a> &raquo;</li>
        
      <li>13 Python函数装饰器高级用法</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/Python进阶/013-Python函数装饰器高级用法.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="python">
<h1>13 Python函数装饰器高级用法<a class="headerlink" href="#python" title="Permalink to this headline">¶</a></h1>
<p><img alt="image1" src="../_images/wanggang6.png" /></p>
<p>在了解了Python函数装饰器基础知识和闭包之后，开始正式学习函数装饰器。</p>
<div class="section" id="id1">
<h2>典型的函数装饰器<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>以下示例定义了一个装饰器，输出函数的运行时间：</p>
<p><img alt="image2" src="../_images/image-20210527083935919.png" /></p>
<p>函数装饰器和闭包紧密结合，入参func代表被装饰函数，通过自由变量绑定后，调用函数并返回结果。</p>
<p>使用clock装饰器：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">clockdeco</span> <span class="kn">import</span> <span class="n">clock</span>

<span class="nd">@clock</span>
<span class="k">def</span> <span class="nf">snooze</span><span class="p">(</span><span class="n">seconds</span><span class="p">):</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>

<span class="nd">@clock</span>
<span class="k">def</span> <span class="nf">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">n</span><span class="o">*</span><span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">,</span> <span class="s1">&#39;Calling snooze(.123)&#39;</span><span class="p">)</span>
    <span class="n">snooze</span><span class="p">(</span><span class="o">.</span><span class="mi">123</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">,</span> <span class="s1">&#39;Calling factorial(6)&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;6! =&#39;</span><span class="p">,</span> <span class="n">factorial</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>  <span class="c1"># 6!指6的阶乘</span>
</pre></div>
</div>
<p>输出结果：</p>
<p><img alt="image3" src="../_images/image-20210527085352366.png" /></p>
<p><strong>这是装饰器的典型行为：把被装饰的函数换成新函数，二者接受相同的参数，而且返回被装饰的函数本该返回的值，同时还会做些额外操作。</strong></p>
<p>值得注意的是factorial()是个递归函数，从结果来看，每次递归都用到了装饰器，打印了运行时间，这是因为如下代码：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@clock</span>
<span class="k">def</span> <span class="nf">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">n</span><span class="o">*</span><span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>等价于：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">n</span><span class="o">*</span><span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="n">factorial</span> <span class="o">=</span> <span class="n">clock</span><span class="p">(</span><span class="n">factorial</span><span class="p">)</span>
</pre></div>
</div>
<p>factorial引用的是clock(factorial)函数的返回值，也就是装饰器内部函数clocked，每次调用factorial(n)，执行的都是clocked(n)。</p>
</div>
<div class="section" id="id2">
<h2>叠放装饰器<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@d1</span>
<span class="nd">@d2</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;f&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>等价于：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;f&quot;</span><span class="p">)</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">d1</span><span class="p">(</span><span class="n">d2</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h2>参数化装饰器<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>怎么让装饰器接受参数呢？答案是：创建一个装饰器工厂函数，把参数传给它，返回一个装饰器，然后再把它应用到要装饰的函数上。</p>
<p>示例如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">registry</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">decorate</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;running register(active=</span><span class="si">%s</span><span class="s1">)-&gt;decorate(</span><span class="si">%s</span><span class="s1">)&#39;</span>
              <span class="o">%</span> <span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="n">func</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
            <span class="n">registry</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">registry</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">func</span>
    <span class="k">return</span> <span class="n">decorate</span>

<span class="nd">@register</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">f1</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;running f1()&#39;</span><span class="p">)</span>

<span class="c1">## 注意这里的调用</span>
<span class="nd">@register</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">f2</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;running f2()&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">f3</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;running f3()&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>register是一个装饰器工厂函数，接受可选参数active默认为True，内部定义了一个装饰器decorate并返回。需要注意的是<strong>装饰器工厂函数，即使不传参数，也要加上小括号调用</strong>，比如<code class="docutils literal notranslate"><span class="pre">&#64;register()</span></code>。</p>
<p>再看一个示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="n">DEFAULT_FMT</span> <span class="o">=</span> <span class="s1">&#39;[</span><span class="si">{elapsed:0.8f}</span><span class="s1">s] </span><span class="si">{name}</span><span class="s1">(</span><span class="si">{args}</span><span class="s1">) -&gt; </span><span class="si">{result}</span><span class="s1">&#39;</span>

<span class="c1">## 装饰器工厂函数</span>
<span class="k">def</span> <span class="nf">clock</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="n">DEFAULT_FMT</span><span class="p">):</span>
    <span class="c1"># 真正的装饰器</span>
    <span class="k">def</span> <span class="nf">decorate</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="c1"># 包装被装饰的函数</span>
        <span class="k">def</span> <span class="nf">clocked</span><span class="p">(</span><span class="o">*</span><span class="n">_args</span><span class="p">):</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="c1"># _result是被装饰函数返回的真正结果</span>
            <span class="n">_result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">_args</span><span class="p">)</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">args</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">_args</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">_result</span><span class="p">)</span>
            <span class="c1"># **locals()返回clocked的局部变量</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">()))</span>
            <span class="k">return</span> <span class="n">_result</span>
        <span class="k">return</span> <span class="n">clocked</span>
    <span class="k">return</span> <span class="n">decorate</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="nd">@clock</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">snooze</span><span class="p">(</span><span class="n">seconds</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">snooze</span><span class="p">(</span><span class="o">.</span><span class="mi">123</span><span class="p">)</span>
</pre></div>
</div>
<p>这是给典型的函数装饰器添加了参数fmt，<strong>装饰器工厂函数增加了一层嵌套，示例中一共有3个def</strong>。</p>
</div>
<div class="section" id="id4">
<h2>标准库中的装饰器<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p>Python内置了三个用于装饰方法的函数：property、classmethod和staticmethod，这会在将来的文章中讲到。本文介绍functools中的三个装饰器：functools.wraps、functools.lru_cache和functools.singledispatch。</p>
<div class="section" id="functools-wraps">
<h3>functools.wraps<a class="headerlink" href="#functools-wraps" title="Permalink to this headline">¶</a></h3>
<p>Python函数装饰器在实现的时候，被装饰后的函数其实已经是另外一个函数了（函数名等函数属性会发生改变），为了不影响，Python的functools包中提供了一个叫wraps的装饰器来消除这样的副作用（它能保留原有函数的名称和函数属性）。</p>
<p>示例，不加wraps：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;decorator&#39;&#39;&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calling decorated function...&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>

<span class="nd">@my_decorator</span>
<span class="k">def</span> <span class="nf">example</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Docstring&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Called example function&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">example</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">example</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
<span class="c1">## 输出wrapper decorator</span>
</pre></div>
</div>
<p>加wraps：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">functools</span>


<span class="k">def</span> <span class="nf">my_decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;decorator&#39;&#39;&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calling decorated function...&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>

<span class="nd">@my_decorator</span>
<span class="k">def</span> <span class="nf">example</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Docstring&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Called example function&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">example</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">example</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
<span class="c1">## 输出example Docstring</span>
</pre></div>
</div>
</div>
<div class="section" id="functools-lru-cache">
<h3>functools.lru_cache<a class="headerlink" href="#functools-lru-cache" title="Permalink to this headline">¶</a></h3>
<p>lru是Least Recently
Used的缩写，它是一项优化技术，把耗时的函数的结果保存起来，避免传入相同的参数时重复计算。</p>
<p>示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">functools</span>

<span class="kn">from</span> <span class="nn">clockdeco</span> <span class="kn">import</span> <span class="n">clock</span>

<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">()</span>
<span class="nd">@clock</span>
<span class="k">def</span> <span class="nf">fibonacci</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">n</span>
    <span class="k">return</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">fibonacci</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
</pre></div>
</div>
<p>优化了<strong>递归</strong>算法，执行时间会减半。</p>
<p>注意，lru_cache可以使用两个可选的参数来配置，它的签名如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">typed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>maxsize：最大存储数量，缓存满了以后，旧的结果会被扔掉。</p></li>
<li><p>typed：如果设为True，那么会把不同参数类型得到的结果分开保存，即把通常认为相等的浮点数和整型参数（如1和1.0）区分开。</p></li>
</ul>
</div>
<div class="section" id="functools-singledispatch">
<h3>functools.singledispatch<a class="headerlink" href="#functools-singledispatch" title="Permalink to this headline">¶</a></h3>
<p>Python3.4的新增语法，可以用来优化函数中的大量<code class="docutils literal notranslate"><span class="pre">if/elif/elif</span></code>。使用<code class="docutils literal notranslate"><span class="pre">&#64;singledispatch</span></code>装饰的普通函数会变成泛函数：根据<strong>第一个参数的类型</strong>，以不同方式执行相同操作的一组函数。所以它叫做single
dispatch，单分派。</p>
<blockquote>
<div><p>根据多个参数进行分派，就是多分派了。</p>
</div></blockquote>
<p>示例，生成HTML，显示不同类型的Python对象：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">html</span>


<span class="k">def</span> <span class="nf">htmlize</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
    <span class="k">return</span> <span class="s1">&#39;&lt;pre&gt;</span><span class="si">{}</span><span class="s1">&lt;/pre&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</pre></div>
</div>
<p>因为Python不支持重载方法或函数，所以就不能使用不同的签名定义htmlize的变体，只能把htmlize变成一个分派函数，使用<code class="docutils literal notranslate"><span class="pre">if/elif/elif</span></code>，调用专门的函数，比如htmlize_str、htmlize_int等。时间一长htmlize会变得很大，跟各个专门函数之间的耦合也很紧密，不便于模块扩展。</p>
<p><code class="docutils literal notranslate"><span class="pre">&#64;singledispatch</span></code>经过深思熟虑后加入到了标准库，来解决这类问题：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">singledispatch</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">abc</span>
<span class="kn">import</span> <span class="nn">numbers</span>
<span class="kn">import</span> <span class="nn">html</span>

<span class="nd">@singledispatch</span>
<span class="k">def</span> <span class="nf">htmlize</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="c1"># 基函数 这里不用写if/elif/elif来分派了</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
    <span class="k">return</span> <span class="s1">&#39;&lt;pre&gt;</span><span class="si">{}</span><span class="s1">&lt;/pre&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

<span class="nd">@htmlize</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="c1"># 专门函数</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;br&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;&lt;p&gt;</span><span class="si">{0}</span><span class="s1">&lt;/p&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

<span class="nd">@htmlize</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">numbers</span><span class="o">.</span><span class="n">Integral</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="c1"># 专门函数</span>
    <span class="k">return</span> <span class="s1">&#39;&lt;pre&gt;</span><span class="si">{0}</span><span class="s1"> (0x</span><span class="si">{0:x}</span><span class="s1">)&lt;/pre&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<span class="nd">@htmlize</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="nb">tuple</span><span class="p">)</span>
<span class="nd">@htmlize</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">MutableSequence</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_</span><span class="p">(</span><span class="n">seq</span><span class="p">):</span>
    <span class="c1"># 专门函数</span>
    <span class="n">inner</span> <span class="o">=</span> <span class="s1">&#39;&lt;/li&gt;</span><span class="se">\n</span><span class="s1">&lt;li&gt;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">htmlize</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">seq</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;&lt;ul&gt;</span><span class="se">\n</span><span class="s1">&lt;li&gt;&#39;</span> <span class="o">+</span> <span class="n">inner</span> <span class="o">+</span> <span class="s1">&#39;&lt;/li&gt;</span><span class="se">\n</span><span class="s1">&lt;/ul&gt;&#39;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">&#64;singledispatch</span></code>装饰了基函数。专门函数使用<code class="docutils literal notranslate"><span class="pre">&#64;&lt;&lt;base_function&gt;&gt;.register(&lt;&lt;type&gt;&gt;)</span></code>装饰，它的名字不重要，命名为<code class="docutils literal notranslate"><span class="pre">_</span></code>，简单明了。</p>
<p>这样编写代码后，Python会根据第一个参数的类型，调用相应的专门函数。</p>
</div>
</div>
<div class="section" id="id5">
<h2>小结<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<p>本文首先介绍了典型的函数装饰器：把被装饰的函数换成新函数，二者接受相同的参数，而且返回被装饰的函数本该返回的值，同时还会做些额外操作。接着介绍了装饰器的两个高级用法：叠放装饰器和参数化装饰器，它们都会增加函数的嵌套层级。最后介绍了3个标准库中的装饰器：保留原有函数属性的functools.wraps、缓存耗时的函数结果的functools.lru_cache和优化<code class="docutils literal notranslate"><span class="pre">if/elif/elif</span></code>代码的functools.singledispatch。</p>
<blockquote>
<div><p>参考资料：</p>
<p>《流畅的Python》</p>
<p><a class="reference external" href="https://github.com/fluentpython/example-code/tree/master/07-closure-deco">https://github.com/fluentpython/example-code/tree/master/07-closure-deco</a></p>
<p><a class="reference external" href="https://blog.csdn.net/liuzonghao88/article/details/103586634">https://blog.csdn.net/liuzonghao88/article/details/103586634</a></p>
</div></blockquote>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="014-Python%E5%AD%97%E7%AC%A6%E4%B8%8E%E5%AD%97%E8%8A%82%E6%96%B0%E7%BC%96.html" class="btn btn-neutral float-right" title="14 Python字符与字节新编" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="012-%E5%85%B3%E4%BA%8EPython%E9%97%AD%E5%8C%85%E7%9A%84%E4%B8%80%E5%88%87.html" class="btn btn-neutral float-left" title="12 关于Python闭包的一切" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright dongfanger

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>