

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>2 学习版pytest内核测试平台开发万字长文入门篇 &mdash; 自动化代码美学 latest documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/js/readmore.js"></script>
        <script src="../_static/js/baidutongji.js"></script>
        <script src="../_static/js/valine.js"></script>
        <script src="../_static/js/Valine.min.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="3 teprunner测试平台部署到Linux系统Docker" href="003-teprunner%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0%E9%83%A8%E7%BD%B2%E5%88%B0Linux%E7%B3%BB%E7%BB%9FDocker.html" />
    <link rel="prev" title="1 pytest内核测试平台落地初体验" href="001-pytest%E5%86%85%E6%A0%B8%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0%E8%90%BD%E5%9C%B0%E5%88%9D%E4%BD%93%E9%AA%8C.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> 自动化代码美学
          

          
          </a>

          
            
            
              <div class="version">
                latest
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../preface.html">前言</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/Python%E5%85%A5%E9%97%A8.html">Python入门</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/Python%E8%BF%9B%E9%98%B6.html">Python进阶</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/pytest%E5%8E%9F%E7%94%9F%E6%A1%86%E6%9E%B6.html">pytest原生框架</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/tep%E5%BC%80%E6%BA%90%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7.html">tep开源测试工具</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../chapters/teprunner%E5%BC%80%E6%BA%90%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0.html">teprunner开源测试平台</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="001-pytest%E5%86%85%E6%A0%B8%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0%E8%90%BD%E5%9C%B0%E5%88%9D%E4%BD%93%E9%AA%8C.html">1 pytest内核测试平台落地初体验</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">2 学习版pytest内核测试平台开发万字长文入门篇</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">前言</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">功能展示</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id3">登录</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">接口自动化</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">小工具</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">后台管理</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id7">本文开发内容</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id8">技术栈</a></li>
<li class="toctree-l3"><a class="reference internal" href="#vue">创建Vue项目</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id9">编写Vue代码</a></li>
<li class="toctree-l3"><a class="reference internal" href="#django">创建Django项目</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id10">编写Django代码</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id11">前后端联调</a></li>
<li class="toctree-l3"><a class="reference internal" href="#postmanmock-server">Postman搭建Mock Server</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id12">小结</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="003-teprunner%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0%E9%83%A8%E7%BD%B2%E5%88%B0Linux%E7%B3%BB%E7%BB%9FDocker.html">3 teprunner测试平台部署到Linux系统Docker</a></li>
<li class="toctree-l2"><a class="reference internal" href="004-teprunner%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0%E7%94%A8%E4%BE%8B%E5%89%8D%E7%BD%AE%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91.html">4 teprunner测试平台用例前置模块开发</a></li>
<li class="toctree-l2"><a class="reference internal" href="005-teprunner%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0%E5%BC%80%E5%8F%91%E7%94%A8%E4%BE%8B%E7%AE%A1%E7%90%86%E4%B8%8D%E5%8F%AA%E6%9C%89%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5.html">5 teprunner测试平台开发用例管理不只有增删改查</a></li>
<li class="toctree-l2"><a class="reference internal" href="006-teprunner%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0Django%E5%BC%95%E5%85%A5pytest%E5%AE%8C%E6%95%B4%E6%BA%90%E7%A0%81.html">6 teprunner测试平台Django引入pytest完整源码</a></li>
<li class="toctree-l2"><a class="reference internal" href="007-teprunner%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0%E6%B5%8B%E8%AF%95%E8%AE%A1%E5%88%92%E6%89%B9%E9%87%8F%E8%BF%90%E8%A1%8C%E7%94%A8%E4%BE%8B.html">7 teprunner测试平台测试计划批量运行用例</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/Django.html">Django</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/Django%20REST%20framework.html">Django REST framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/Java%E5%85%A5%E9%97%A8.html">Java入门</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/JMeter.html">JMeter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/%E8%A7%86%E9%A2%91%E6%95%99%E7%A8%8B.html">视频教程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/%E5%B9%B4%E5%BA%A6%E6%80%BB%E7%BB%93.html">年度总结</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/%E6%88%90%E9%95%BF%E5%B0%8F%E8%AF%B4.html">成长小说</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aboutme.html">关于作者</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contact.html">联系方式</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/%E9%9D%A2%E8%AF%95%E9%A2%98.html">附录 面试题</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">自动化代码美学</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../chapters/teprunner%E5%BC%80%E6%BA%90%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0.html">teprunner开源测试平台</a> &raquo;</li>
        
      <li>2 学习版pytest内核测试平台开发万字长文入门篇</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/teprunner开源测试平台/002-学习版pytest内核测试平台开发万字长文入门篇.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="pytest">
<h1>2 学习版pytest内核测试平台开发万字长文入门篇<a class="headerlink" href="#pytest" title="Permalink to this headline">¶</a></h1>
<p><img alt="image1" src="../_images/wanggang7.png" /></p>
<div class="section" id="id1">
<h2>前言<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>2021年，测试平台如雨后春笋般冒了出来，我就是其中一员，写了一款pytest内核测试平台，在公司落地。分享出来后，有同学觉得挺不错，希望能开源，本着“公司代码不要传到网上去，以免引起不必要麻烦”的原则，只能在家从头写一个，边重新梳理代码边温习巩固知识点，以学习交流为目的，定义为“学习版”。</p>
</div>
<div class="section" id="id2">
<h2>功能展示<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id3">
<h3>登录<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p><img alt="image2" src="../_images/image-20210306090248863.png" /></p>
</div>
<div class="section" id="id4">
<h3>接口自动化<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>接口自动化–Dashboard：</p>
<p><img alt="image3" src="../_images/image-20210304180738292.png" /></p>
<p>接口自动化–环境变量：</p>
<p><img alt="image4" src="../_images/image-20210304180813476.png" /></p>
<p>接口自动化–fixtures：</p>
<p><img alt="image5" src="../_images/image-20210304180834964.png" /></p>
<p>接口自动化–用例管理：</p>
<p><img alt="image6" src="../_images/image-20210304180922929.png" /></p>
<p>接口自动化–用例管理–编辑用例：</p>
<p><img alt="image7" src="../_images/image-20210305085858572.png" /></p>
<p>接口自动化–测试计划：</p>
<p><img alt="image8" src="../_images/image-20210304180948635.png" /></p>
<p>接口自动化–语法说明：</p>
<p><img alt="image9" src="../_images/image-20210304181008401.png" /></p>
</div>
<div class="section" id="id5">
<h3>小工具<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>小工具–共享脚本：</p>
<p><img alt="image10" src="../_images/image-20210304181055775.png" /></p>
<p>小工具–HTTP状态查询：</p>
<p><img alt="image11" src="../_images/image-20210304181112261.png" /></p>
</div>
<div class="section" id="id6">
<h3>后台管理<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>后台管理–用户管理</p>
<p><img alt="image12" src="../_images/image-20210304181143186.png" /></p>
<p>后台管理–项目管理</p>
<p><img alt="image13" src="../_images/image-20210304181206729.png" /></p>
</div>
</div>
<div class="section" id="id7">
<h2>本文开发内容<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>登录，登出</p></li>
<li><p>首页，修改密码，个人信息</p></li>
<li><p>后台管理，用户管理</p></li>
<li><p>JWT认证</p></li>
</ul>
<p>本文先打个基础，既是测试平台基本结构，也可以作为CMS基础框架，定制开发各种小型项目。</p>
</div>
<div class="section" id="id8">
<h2>技术栈<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Node.js 12.16.3</p></li>
<li><p>Vue 4.5.11</p></li>
<li><p>Python 3.8</p></li>
<li><p>Django 3.1.3</p></li>
<li><p>Django REST framework 3.12.2</p></li>
<li><p>SQLite 3</p></li>
</ul>
<p>IDE编辑器推荐PyCharm旗舰版，既能写Django也能写Vue项目。数据库使用Django自带SQLite
，省去安装MySQL和Navicat/Workbench麻烦，轻量级开发。SQLiteStudio为SQLite数据库可视化工具，只需要下载即可，无需安装，解压就用：：</p>
<p><a class="reference external" href="https://sqlitestudio.pl/">https://sqlitestudio.pl/</a></p>
<p><img alt="image14" src="../_images/image-20210304213603156.png" /></p>
<p>由于会用到<code class="docutils literal notranslate"><span class="pre">models.JSONField</span></code>，SQLite默认不兼容，所以需要下载<code class="docutils literal notranslate"><span class="pre">sqlite3.dll</span></code>文件替换下：</p>
<p><a class="reference external" href="https://www.sqlite.org/download.html">https://www.sqlite.org/download.html</a></p>
<p>根据Python版本选择，比如我的windows安装的Python38-32，下载了<code class="docutils literal notranslate"><span class="pre">sqlite-dll-win32-x86-3340100.zip</span></code>这个软件包，解压后将<code class="docutils literal notranslate"><span class="pre">D:\Program</span> <span class="pre">Files</span> <span class="pre">(x86)\Python38-32\DLLs\sqlite3.dll</span></code>替换。</p>
</div>
<div class="section" id="vue">
<h2>创建Vue项目<a class="headerlink" href="#vue" title="Permalink to this headline">¶</a></h2>
<p>设置<code class="docutils literal notranslate"><span class="pre">npm</span></code>淘宝镜像：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>npm config <span class="nb">set</span> registry https://registry.npm.taobao.org
</pre></div>
</div>
<p>安装<code class="docutils literal notranslate"><span class="pre">Vue</span> <span class="pre">CLI</span></code>：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>npm install -g @vue/cli
</pre></div>
</div>
<p>创建<code class="docutils literal notranslate"><span class="pre">teprunner-frontend</span></code>项目：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>vue create teprunner-frontend
</pre></div>
</div>
<blockquote>
<div><p>项目名字请随意。</p>
</div></blockquote>
<p>默认选项点击回车进行创建：</p>
<p><img alt="image15" src="../_images/image-20210305124737919.png" /></p>
</div>
<div class="section" id="id9">
<h2>编写Vue代码<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h2>
<p>添加静态资源：</p>
<p><img alt="image16" src="../_images/image-20210306140431231.png" /></p>
<p>包括css样式、字体样式、图标、logo。</p>
<blockquote>
<div><p>推荐一个图标下载网站：<a class="reference external" href="https://www.easyicon.net/">https://www.easyicon.net/</a>。</p>
</div></blockquote>
<p>编辑<code class="docutils literal notranslate"><span class="pre">package.json</span></code>，安装项目所需依赖：</p>
<p><img alt="image17" src="../_images/image-20210306142926468.png" /></p>
<p><code class="docutils literal notranslate"><span class="pre">axios</span></code>用于异步请求，发送<code class="docutils literal notranslate"><span class="pre">http</span></code>给后端。<code class="docutils literal notranslate"><span class="pre">element-ui</span></code>为饿了么开源前端框架，简化了从头写html麻烦，高度复用，统一风格。<code class="docutils literal notranslate"><span class="pre">vue-router</span></code>提供了路由跳转，在上个时代，路由是在后端来控制的，把页面渲染后返回给前端直接展示，前后端分离后，后端只负责返回数据，把控制权交给前端。</p>
<p><code class="docutils literal notranslate"><span class="pre">devDependencies</span></code>是写代码用到的依赖，这里把<code class="docutils literal notranslate"><span class="pre">eslint</span></code>和<code class="docutils literal notranslate"><span class="pre">prettier</span></code>标出来了，它们是用来做代码静态检查的，配置后能给与代码规范提示，帮你写出更漂亮的代码，同样是在<code class="docutils literal notranslate"><span class="pre">package.json</span></code>文件编辑：</p>
<p><img alt="image18" src="../_images/image-20210306144255241.png" /></p>
<p>接着执行<code class="docutils literal notranslate"><span class="pre">npm</span> <span class="pre">install</span></code>进行安装。有可能会出现下图提示：</p>
<p><img alt="image19" src="../_images/image-20210305095937989.png" /></p>
<p>执行<code class="docutils literal notranslate"><span class="pre">npm</span> <span class="pre">audit</span> <span class="pre">fix</span></code>就修复好了：</p>
<p><img alt="image20" src="../_images/image-20210305100051047.png" /></p>
<p>新建<code class="docutils literal notranslate"><span class="pre">vue.config.js</span></code>文件，添加Vue项目配置：</p>
<p><img alt="image21" src="../_images/image-20210307072940767.png" /></p>
<p><code class="docutils literal notranslate"><span class="pre">args[0].title</span></code>给网页设置了浏览器title。<code class="docutils literal notranslate"><span class="pre">proxy</span></code>指定了后端接口根路径为<code class="docutils literal notranslate"><span class="pre">/api</span></code>，后端服务器访问地址为<code class="docutils literal notranslate"><span class="pre">http://127.0.0.1:8000/</span></code>，这是Django启动后默认本地域名和端口。<code class="docutils literal notranslate"><span class="pre">element-ui</span></code>默认页面是会出现滚动条的，在登录页会显得很丑，需要在<code class="docutils literal notranslate"><span class="pre">public/index.html</span></code>加上样式：</p>
<p><img alt="image22" src="../_images/image-20210306144657713.png" /></p>
<p>Vue程序执行入口是<code class="docutils literal notranslate"><span class="pre">main.js</span></code>，把需要初始化加载的代码写在这里：</p>
<p><img alt="image23" src="../_images/image-20210306145108245.png" /></p>
<p>app会挂载到<code class="docutils literal notranslate"><span class="pre">index.html</span></code>文件中<code class="docutils literal notranslate"><span class="pre">div</span></code>：</p>
<p><img alt="image24" src="../_images/image-20210306145301713.png" /></p>
<p>这是整个Vue项目唯一的<code class="docutils literal notranslate"><span class="pre">html</span></code>文件，其他组件都是挂载到这个<code class="docutils literal notranslate"><span class="pre">div</span></code>下面的。其中有个<code class="docutils literal notranslate"><span class="pre">App.vue</span></code>：</p>
<p><img alt="image25" src="../_images/image-20210306145518745.png" /></p>
<p>它叫做根组件，<code class="docutils literal notranslate"><span class="pre">router-view</span></code>是一块区域，用来展示路由匹配到的组件，也就是说所有路由匹配到的组件都会通过<code class="docutils literal notranslate"><span class="pre">App.vue</span></code>根组件来展示。路由配置在<code class="docutils literal notranslate"><span class="pre">router/index.js</span></code>文件中编辑：</p>
<p><img alt="image26" src="../_images/image-20210306155800462.png" /></p>
<p>第一层路由是<code class="docutils literal notranslate"><span class="pre">/login</span></code>登录和<code class="docutils literal notranslate"><span class="pre">/</span></code>首页，首页只有菜单，没有具体内容，显示没有意义，所以重定向到了后台管理的用户管理。第二层路由是具体的功能模块，作为子路由放在首页路由下，比如后台管理。后台管理的子模块用户管理也放到了后台管理的子路由，根据<code class="docutils literal notranslate"><span class="pre">url</span></code>访问路径定义父子路由关系。</p>
<p>为了在未登录的情况下，不允许访问首页，需要再加上访问拦截：</p>
<p><img alt="image27" src="../_images/image-20210306160650302.png" /></p>
<p>同时添加了<code class="docutils literal notranslate"><span class="pre">meta.requireAuth</span></code>，用来设置哪些路由需要拦截，这里把首页设置为<code class="docutils literal notranslate"><span class="pre">True</span></code>：</p>
<p><img alt="image28" src="../_images/image-20210306160844577.png" /></p>
<p>登录就不需要了。路由配置完成了，接着编写页面代码，Vue项目的页面只有<code class="docutils literal notranslate"><span class="pre">index.html</span></code>一个<code class="docutils literal notranslate"><span class="pre">html</span></code>文件，其他页面都是放在<code class="docutils literal notranslate"><span class="pre">views</span></code>文件夹下，新建一个<code class="docutils literal notranslate"><span class="pre">views/login/index.vue</span></code>文件：</p>
<p><img alt="image29" src="../_images/image-20210306161200994.png" /></p>
<p>使用<code class="docutils literal notranslate"><span class="pre">el-form</span></code>标签添加用户名、密码、忘记密码和登录按钮。<code class="docutils literal notranslate"><span class="pre">:model</span></code>给表单绑定了数据对象，分别填充到<code class="docutils literal notranslate"><span class="pre">form.username</span></code>、<code class="docutils literal notranslate"><span class="pre">form.password</span></code>、<code class="docutils literal notranslate"><span class="pre">form.rememberMe</span></code>：</p>
<p><img alt="image30" src="../_images/image-20210306161445594.png" /></p>
<p><code class="docutils literal notranslate"><span class="pre">:rules</span></code>定义了表单规则，比如是否必填：</p>
<p><img alt="image31" src="../_images/image-20210306161512988.png" /></p>
<blockquote>
<div><p>登录没有做用户名和密码校验，新增用户时才会做校验。</p>
</div></blockquote>
<p>在创建登录界面时，从<code class="docutils literal notranslate"><span class="pre">localStorage</span></code>中移除<code class="docutils literal notranslate"><span class="pre">userInfo</span></code>和<code class="docutils literal notranslate"><span class="pre">token</span></code>，登录信息保留7天：</p>
<p><img alt="image32" src="../_images/image-20210306161719636.png" /></p>
<p>点击登录按钮会调用<code class="docutils literal notranslate"><span class="pre">login</span></code>方法，发起登录请求：</p>
<p><img alt="image33" src="../_images/image-20210306161951064.png" /></p>
<p>新建<code class="docutils literal notranslate"><span class="pre">views/home/index.vue</span></code>，编写首页代码：</p>
<p><img alt="image34" src="../_images/image-20210306162302099.png" /></p>
<p><code class="docutils literal notranslate"><span class="pre">&lt;router-link&gt;</span></code>提供了链接跳转，左上角logo跳转到首页，顶部导航栏根据后端返回的<code class="docutils literal notranslate"><span class="pre">authList</span></code>权限菜单进行显示，因为后台管理只有管理员才能访问。接着编写右上角区域代码：</p>
<p><img alt="image35" src="../_images/image-20210306162558208.png" /></p>
<p>包括修改密码、个人信息和退出登录，为了简单一点，没有弄头像了。修改密码使用<code class="docutils literal notranslate"><span class="pre">el-dialog</span></code>做了个弹出框：</p>
<p><img alt="image36" src="../_images/image-20210306162723461.png" /></p>
<p>包括当前密码、新密码、确认新密码。并添加了校验规则：</p>
<p><img alt="image37" src="../_images/image-20210306162836437.png" /></p>
<p>修改密码会调用<code class="docutils literal notranslate"><span class="pre">/users/passwords/set</span></code>接口：</p>
<p><img alt="image38" src="../_images/image-20210306162952412.png" /></p>
<p>同时初始化菜单权限，从后端获取<code class="docutils literal notranslate"><span class="pre">authList</span></code>，并判断是否有权限，没有权限的话跳转到登录页面：</p>
<p><img alt="image39" src="../_images/image-20210306163723278.png" /></p>
<p>首页除了左上角logo，顶部导航栏，右上角个人信息，还有一个重要的版块就是左侧菜单。由于有了顶部导航栏，左侧菜单如果也放到首页来写，由于层级关系会让代码显得很臃肿，所以菜单是放到每个子模块来做的。每个子模块有左侧菜单，也会存在很多重复容易的代码，为了复用，就抽成组件，放到<code class="docutils literal notranslate"><span class="pre">components</span></code>文件夹下：</p>
<p><img alt="image40" src="../_images/image-20210306164108392.png" /></p>
<p>用到了<code class="docutils literal notranslate"><span class="pre">el-menu</span></code>标签：</p>
<p><img alt="image41" src="../_images/image-20210306164218151.png" /></p>
<p><code class="docutils literal notranslate"><span class="pre">slot</span></code>是个插槽，相当于挖个坑在这，用的时候填一下坑，类似于模板。然后用<code class="docutils literal notranslate"><span class="pre">el-breadcrumb</span></code>做了个面包屑，点击可跳转到相应路由。接着就把左侧菜单应用到后台管理模块上，新建<code class="docutils literal notranslate"><span class="pre">views/console/index.vue</span></code>：</p>
<p><img alt="image42" src="../_images/image-20210306164649177.png" /></p>
<p>左侧菜单搞定了，右侧内容也是类似的，查询、表格、分页、增删改查，也需要抽成组件：</p>
<p><img alt="image43" src="../_images/image-20210306164954122.png" /></p>
<p><img alt="image44" src="../_images/image-20210306165236756.png" /></p>
<p>再新建<code class="docutils literal notranslate"><span class="pre">views/console/userManagement.vue</span></code>，编写用户管理代码：</p>
<p><img alt="image45" src="../_images/image-20210306165536649.png" /></p>
<p>用到了<code class="docutils literal notranslate"><span class="pre">el-form</span></code>和<code class="docutils literal notranslate"><span class="pre">el-table</span></code>标签。表格数据通过<code class="docutils literal notranslate"><span class="pre">:data</span></code>绑定到了<code class="docutils literal notranslate"><span class="pre">tableData</span></code>对象，调用后端接口后，从响应中拿数据填充：</p>
<p><img alt="image46" src="../_images/image-20210306165655643.png" /></p>
<p>新增用户弹窗的入口也是放在这个文件中的：</p>
<p><img alt="image47" src="../_images/image-20210306165925367.png" /></p>
<p><code class="docutils literal notranslate"><span class="pre">dialogFormVisible</span></code>默认为<code class="docutils literal notranslate"><span class="pre">False</span></code>不可见，点击新增按钮后，会设置为<code class="docutils literal notranslate"><span class="pre">True</span></code>。新建<code class="docutils literal notranslate"><span class="pre">views/console/addUser.vue</span></code>文件编写用户弹窗的代码：</p>
<p><img alt="image48" src="../_images/image-20210306170204228.png" /></p>
<p>用户管理<code class="docutils literal notranslate"><span class="pre">userManagement.vue</span></code>和新增用户<code class="docutils literal notranslate"><span class="pre">addUser.vue</span></code>这两个组件叫做父子组件，父组件如果想传值给子组件，需要通过<code class="docutils literal notranslate"><span class="pre">props</span></code>来实现：</p>
<p><img alt="image49" src="../_images/image-20210306170335128.png" /></p>
<p><code class="docutils literal notranslate"><span class="pre">watch</span></code>能监视传值的状态，及时渲染。</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">watch</span></code>不是必须的，等到做编辑用例和用例运行结果的时候，会更加体会到它的作用。</p>
</div></blockquote>
<p>新增用户时，会对用户名和密码做校验：</p>
<p><img alt="image50" src="../_images/image-20210306171236501.png" /></p>
<p><code class="docutils literal notranslate"><span class="pre">nameValidator</span></code>和<code class="docutils literal notranslate"><span class="pre">pwdValidator</span></code>是公共方法，定义在<code class="docutils literal notranslate"><span class="pre">utils/const.js</span></code>文件中：</p>
<p><img alt="image51" src="../_images/image-20210306171637315.png" /></p>
<p><code class="docutils literal notranslate"><span class="pre">utils</span></code>文件夹下还有个<code class="docutils literal notranslate"><span class="pre">commonMethods.js</span></code>文件，定义了一些公共<code class="docutils literal notranslate"><span class="pre">js</span></code>方法：</p>
<p><img alt="image52" src="../_images/image-20210306171736326.png" /></p>
<p>本次前端代码基本编写完成了：</p>
<p><img alt="image53" src="../_images/image-20210306171934196.png" /></p>
<p>最后还有个<code class="docutils literal notranslate"><span class="pre">axios.js</span></code>，它定义了异步请求实例：</p>
<p><img alt="image54" src="../_images/image-20210306172105879.png" /></p>
<p>添加了一个请求拦截器：</p>
<p><img alt="image55" src="../_images/image-20210306172149351.png" /></p>
<p>校验<code class="docutils literal notranslate"><span class="pre">header</span></code>需要包括<code class="docutils literal notranslate"><span class="pre">jwt</span></code>请求头：<code class="docutils literal notranslate"><span class="pre">Authorization:</span> <span class="pre">Bearer</span></code>。还添加了一个响应拦截器：</p>
<p><img alt="image56" src="../_images/image-20210306172302154.png" /></p>
<p>对错误信息进行捕获并弹框提示。</p>
</div>
<div class="section" id="django">
<h2>创建Django项目<a class="headerlink" href="#django" title="Permalink to this headline">¶</a></h2>
<p>安装Django：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pip install --default-timeout<span class="o">=</span><span class="m">6000</span> -i https://pypi.tuna.tsinghua.edu.cn/simple django
</pre></div>
</div>
<p>创建<code class="docutils literal notranslate"><span class="pre">teprunner-backend</span></code>项目：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>django-admin startproject teprunnerbackend
</pre></div>
</div>
<blockquote>
<div><p>项目名字请随意。</p>
</div></blockquote>
<p>注意这条命令的项目名字不能带短横线<code class="docutils literal notranslate"><span class="pre">-</span></code>，如果想用短横线，可以先去掉短横线执行命令，再手动改回来，外层这个名字对项目没有任何影响：</p>
<p><img alt="image57" src="../_images/image-20210304233802571.png" /></p>
</div>
<div class="section" id="id10">
<h2>编写Django代码<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h2>
<p>安装依赖包：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pip install --default-timeout<span class="o">=</span><span class="m">6000</span> -i https://pypi.tuna.tsinghua.edu.cn/simple -r requirements.txt
</pre></div>
</div>
<p><img alt="image58" src="../_images/image-20210306173835344.png" /></p>
<p>创建<code class="docutils literal notranslate"><span class="pre">user</span></code>应用:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>django-admin startapp user
</pre></div>
</div>
<p><img alt="image59" src="../_images/image-20210306174151316.png" /></p>
<p>配置<code class="docutils literal notranslate"><span class="pre">teprunnerbackend/settings.py</span></code>:</p>
<p><img alt="image60" src="../_images/image-20210306173916888.png" /></p>
<p><code class="docutils literal notranslate"><span class="pre">django-cors-headers</span></code>为Django提供了跨域访问的解决方案，需要配置<code class="docutils literal notranslate"><span class="pre">ALLOWED_HOSTS</span></code>为<code class="docutils literal notranslate"><span class="pre">*</span></code>，允许所有域访问，并注册<code class="docutils literal notranslate"><span class="pre">INSTALLED_APPS</span></code>和<code class="docutils literal notranslate"><span class="pre">MIDDLEWARE</span></code>。<code class="docutils literal notranslate"><span class="pre">user</span></code>应用也需要在<code class="docutils literal notranslate"><span class="pre">INSTALLED_APPS</span></code>注册后才会生效。继续改配置，把时区改为<code class="docutils literal notranslate"><span class="pre">Asia/Shanghai</span></code>：</p>
<p><img alt="image61" src="../_images/image-20210306174233580.png" /></p>
<p>继续：</p>
<p><img alt="image62" src="../_images/image-20210306174304327.png" /></p>
<p>Django自带了一个权限管理系统，为了简单一点，直接复用。不过需要对<code class="docutils literal notranslate"><span class="pre">user</span></code>表进行自定义改造，所以通过配置里面的<code class="docutils literal notranslate"><span class="pre">AUTH_USER_MODEL</span></code>指定为刚刚创建的<code class="docutils literal notranslate"><span class="pre">user</span></code>应用的<code class="docutils literal notranslate"><span class="pre">User</span></code>。<code class="docutils literal notranslate"><span class="pre">REST_FRAMEWORK</span></code>是Django
RESTful
framework的配置项，同样要进行自定义改造，所以这里通过配置<code class="docutils literal notranslate"><span class="pre">DEFAULT_AUTHENTICATION_CLASSES</span></code>指定认证鉴权类为<code class="docutils literal notranslate"><span class="pre">CustomJSONWebTokenAuthentication</span></code>，通过<code class="docutils literal notranslate"><span class="pre">EXCEPTION_HANDLER</span></code>指定异常处理函数为<code class="docutils literal notranslate"><span class="pre">custom_exception_handler</span></code>，通过<code class="docutils literal notranslate"><span class="pre">DEFAULT_PAGINATION_CLASS</span></code>指定分页类为<code class="docutils literal notranslate"><span class="pre">CustomPagination</span></code>。<code class="docutils literal notranslate"><span class="pre">JWT_AUTH</span></code>是<code class="docutils literal notranslate"><span class="pre">jwt</span></code>的配置项，定义了过期时间为30天，允许刷新，刷新间隔，响应处理，<code class="docutils literal notranslate"><span class="pre">header</span></code>前缀。最后补充了<code class="docutils literal notranslate"><span class="pre">django-cors-headers</span></code>的3个配置。</p>
<p>接着配置<code class="docutils literal notranslate"><span class="pre">teprunnerbackend/urls.py</span></code>：</p>
<p><img alt="image63" src="../_images/image-20210306175004740.png" /></p>
<p>把<code class="docutils literal notranslate"><span class="pre">user</span></code>的<code class="docutils literal notranslate"><span class="pre">url</span></code>都添加到<code class="docutils literal notranslate"><span class="pre">api/users/</span></code>下面。新建<code class="docutils literal notranslate"><span class="pre">user/urls.py</span></code>文件：</p>
<p><img alt="image64" src="../_images/image-20210306181212407.png" /></p>
<p>分别添加登录、用户增删改查、重置密码、角色列表、修改密码几个路径。Django的视图有两个类型：类视图和函数视图。<code class="docutils literal notranslate"><span class="pre">path()</span></code>只接受可调用对象，所以类视图需要使用<code class="docutils literal notranslate"><span class="pre">as_view()</span></code>进行转化，比如<code class="docutils literal notranslate"><span class="pre">views.UserLogin.as_view()</span></code>。函数视图直接写上函数名就可以了，比如<code class="docutils literal notranslate"><span class="pre">views.update_password</span></code>。</p>
<p>打开<code class="docutils literal notranslate"><span class="pre">user/models.py</span></code>文件，添加数据模型：</p>
<p><img alt="image65" src="../_images/image-20210306181627980.png" /></p>
<p><code class="docutils literal notranslate"><span class="pre">model</span></code>建立了代码和数据库的映射，这称为<code class="docutils literal notranslate"><span class="pre">orm</span></code>，对象关系映射。基础表定义了共有的<code class="docutils literal notranslate"><span class="pre">created_at</span></code>和<code class="docutils literal notranslate"><span class="pre">updated_at</span></code>字段。<code class="docutils literal notranslate"><span class="pre">auto_now_add</span></code>表示记录新增时间，<code class="docutils literal notranslate"><span class="pre">auto_now</span></code>表示记录更新时间，都是自动进行，无需手动写代码来处理。用户表继承了Django自带的<code class="docutils literal notranslate"><span class="pre">AbstractUser</span></code>，<code class="docutils literal notranslate"><span class="pre">REQUIRED_FIELDS</span></code>规定了哪些字段必填，<code class="docutils literal notranslate"><span class="pre">username</span></code>和<code class="docutils literal notranslate"><span class="pre">password</span></code>是隐式规定了必填的，不需要设置，默认<code class="docutils literal notranslate"><span class="pre">email</span></code>也是必填，这里把它去掉。</p>
<blockquote>
<div><p>Django默认表名会加上<code class="docutils literal notranslate"><span class="pre">django_</span></code>前缀，使用<code class="docutils literal notranslate"><span class="pre">Meta.db_table</span></code>来定义没有前缀的表名。</p>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">model</span></code>写完了，执行以下命令同步到数据库中，创建表结构：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>python manage.py makemigrations
python manage.py migrate
</pre></div>
</div>
<p>打开<code class="docutils literal notranslate"><span class="pre">SQLiteStudio</span></code>，选择根目录的<code class="docutils literal notranslate"><span class="pre">db.sqlite3</span></code>文件：</p>
<p><img alt="image66" src="../_images/image-20210306204628547.png" /></p>
<p>看到表结构已经创建好了：</p>
<p><img alt="image67" src="../_images/image-20210306204721167.png" /></p>
<p><code class="docutils literal notranslate"><span class="pre">Role</span></code>有个<code class="docutils literal notranslate"><span class="pre">models.JSONField</span></code>字段，为<code class="docutils literal notranslate"><span class="pre">菜单权限JSON</span></code>，使用Django的<code class="docutils literal notranslate"><span class="pre">fixtures</span></code>给项目添加初始化数据：</p>
<p><img alt="image68" src="../_images/image-20210306205247149.png" /></p>
<p><code class="docutils literal notranslate"><span class="pre">fixtures</span></code>名字是固定的，就像pytest的<code class="docutils literal notranslate"><span class="pre">conftest.py</span></code>一样，只认这个名字。<code class="docutils literal notranslate"><span class="pre">user.json</span></code>存放数据：</p>
<p><img alt="image69" src="../_images/image-20210306205357170.png" /></p>
<p>包括管理员用户、角色权限、管理员角色对照关系。其中角色权限数据共3条：</p>
<p><img alt="image70" src="../_images/image-20210306205523009.png" /></p>
<p><code class="docutils literal notranslate"><span class="pre">auth</span></code>里面定义了菜单，对应首页的顶部导航栏的栏目，比如本文只添加了后台管理。<code class="docutils literal notranslate"><span class="pre">access</span></code>表示角色是否有权限访问，只有管理员的这条数据，<code class="docutils literal notranslate"><span class="pre">access</span></code>为<code class="docutils literal notranslate"><span class="pre">true</span></code>。通过以下命令把这些数据写入数据库中：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>python manage.py loaddata user
</pre></div>
</div>
<blockquote>
<div><p>Django会在<code class="docutils literal notranslate"><span class="pre">user.fixtures</span></code>目录下自动找名字为<code class="docutils literal notranslate"><span class="pre">user</span></code>的<code class="docutils literal notranslate"><span class="pre">.json</span></code>、<code class="docutils literal notranslate"><span class="pre">.xml</span></code>或<code class="docutils literal notranslate"><span class="pre">.yaml</span></code>文件进行加载。</p>
</div></blockquote>
<p>接着新建一个<code class="docutils literal notranslate"><span class="pre">user/serializers.py</span></code>文件写序列化的代码。Django序列化是指，把数据库的数据转化为<code class="docutils literal notranslate"><span class="pre">json</span></code>返回给前端，反序列化是指把前端传过来的<code class="docutils literal notranslate"><span class="pre">json</span></code>写入数据库。先写登录的序列化器：</p>
<p><img alt="image71" src="../_images/image-20210306210247811.png" /></p>
<p>继承自<code class="docutils literal notranslate"><span class="pre">serializers.ModelSerializer</span></code>，一般需要在<code class="docutils literal notranslate"><span class="pre">Meta</span></code>定义两个属性，<code class="docutils literal notranslate"><span class="pre">model</span></code>指定相应的模型，<code class="docutils literal notranslate"><span class="pre">fields</span></code>指定所需要的的字段，这些字段就是<code class="docutils literal notranslate"><span class="pre">json</span></code>的<code class="docutils literal notranslate"><span class="pre">key</span></code>。图中的<code class="docutils literal notranslate"><span class="pre">roleName</span></code>不属于<code class="docutils literal notranslate"><span class="pre">User</span></code>表的字段，所以通过定义为<code class="docutils literal notranslate"><span class="pre">serializers.SerializerMethodField()</span></code>，再定义<code class="docutils literal notranslate"><span class="pre">get_roleName()</span></code>方法来取。<code class="docutils literal notranslate"><span class="pre">serializer</span></code>写好后，写视图，编辑<code class="docutils literal notranslate"><span class="pre">user/views.py</span></code>：</p>
<p><img alt="image72" src="../_images/image-20210306213523293.png" /></p>
<p>由于是<code class="docutils literal notranslate"><span class="pre">jwt</span></code>认证，所以这里继承了<code class="docutils literal notranslate"><span class="pre">JSONWebTokenAPIView</span></code>，提取请求参数，<code class="docutils literal notranslate"><span class="pre">check_password()</span></code>简单校验了下请求的密码和数据库的密码<code class="docutils literal notranslate"><span class="pre">hash</span></code>值是否相等，后面的代码是<code class="docutils literal notranslate"><span class="pre">JSONWebTokenAPIView.post</span></code>方法现成的，重写了一遍。<code class="docutils literal notranslate"><span class="pre">ErrInvalidPassword</span></code>等是在<code class="docutils literal notranslate"><span class="pre">user/errors.py</span></code>定义的错误响应：</p>
<p><img alt="image73" src="../_images/image-20210306214715768.png" /></p>
<blockquote>
<div><p>这样可读性会更高。响应状态码也建议这么写<code class="docutils literal notranslate"><span class="pre">status=status.HTTP_500_INTERNAL_SERVER_ERROR</span></code>，<code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">rest_framework</span> <span class="pre">import</span> <span class="pre">status</span></code>已经定义好了所有状态码的常量。</p>
</div></blockquote>
<p>新建<code class="docutils literal notranslate"><span class="pre">user/utils.py</span></code>文件，编写<code class="docutils literal notranslate"><span class="pre">jwt_response_payload_handler</span></code>来定义登录接口的响应结构：</p>
<p><img alt="image74" src="../_images/image-20210306213902276.png" /></p>
<p>返回<code class="docutils literal notranslate"><span class="pre">token</span></code>、<code class="docutils literal notranslate"><span class="pre">user</span></code>、<code class="docutils literal notranslate"><span class="pre">auth</span></code>三个字段。<code class="docutils literal notranslate"><span class="pre">custom_exception_handler</span></code>规范了一下异常响应信息。这2个方法都是在<code class="docutils literal notranslate"><span class="pre">settings.py</span></code>中的<code class="docutils literal notranslate"><span class="pre">REST_FRAMEWORK</span></code>配置过的，还有一项配置是分页，新建<code class="docutils literal notranslate"><span class="pre">user/pagination.py</span></code>文件：</p>
<p><img alt="image75" src="../_images/image-20210306214224740.png" /></p>
<p>继承了<code class="docutils literal notranslate"><span class="pre">PageNumberPagination</span></code>，指定了查询参数名<code class="docutils literal notranslate"><span class="pre">page</span></code>、<code class="docutils literal notranslate"><span class="pre">perPage</span></code>，自定义了响应字段名<code class="docutils literal notranslate"><span class="pre">currentPage</span></code>、<code class="docutils literal notranslate"><span class="pre">items</span></code>、<code class="docutils literal notranslate"><span class="pre">totalNum</span></code>、<code class="docutils literal notranslate"><span class="pre">totalPage</span></code>，并添加了2个字段<code class="docutils literal notranslate"><span class="pre">hasNext</span></code>和<code class="docutils literal notranslate"><span class="pre">hasPrev</span></code>。</p>
<p>最后还有一个配置项，自定义认证鉴权，新增<code class="docutils literal notranslate"><span class="pre">user/authentications.py</span></code>：</p>
<p><img alt="image76" src="../_images/image-20210306215729007.png" /></p>
<p>继承了<code class="docutils literal notranslate"><span class="pre">BaseJSONWebTokenAuthentication</span></code>。通过<code class="docutils literal notranslate"><span class="pre">get_authorization_header</span></code>提取请求头中的<code class="docutils literal notranslate"><span class="pre">Authorization</span></code>字段，没有就提示“缺失JWT请求头”。后面的代码是父类现成的。</p>
<p>至此，整个后端基本代码都写完了，<code class="docutils literal notranslate"><span class="pre">jwt</span></code>认证也做好了：</p>
<p><img alt="image77" src="../_images/image-20210306215415165.png" /></p>
<p>后面的代码就集中在<code class="docutils literal notranslate"><span class="pre">serializers.py</span></code>和<code class="docutils literal notranslate"><span class="pre">views.py</span></code>两个文件，序列化器提供数据库表字段和响应<code class="docutils literal notranslate"><span class="pre">json</span></code>的序列化和反序列化，视图使用序列化器，编写业务处理代码。按照这个思路，编写用户的增删改查功能，先在<code class="docutils literal notranslate"><span class="pre">serializers.py</span></code>文件中写2个序列化器<code class="docutils literal notranslate"><span class="pre">UserCreateSerializer</span></code>和<code class="docutils literal notranslate"><span class="pre">UserPagingSerializer</span></code>：</p>
<p><img alt="image78" src="../_images/image-20210306220633866.png" /></p>
<p>由于新增用户和用户列表展示的字段不一样，所以给同一个<code class="docutils literal notranslate"><span class="pre">User</span></code>模型创建了2个序列化器。图中标红了代码是把<code class="docutils literal notranslate"><span class="pre">int</span></code>的<code class="docutils literal notranslate"><span class="pre">id</span></code>值转化为了<code class="docutils literal notranslate"><span class="pre">str</span></code>类型，方便前端处理。<code class="docutils literal notranslate"><span class="pre">is_staff</span></code>表示是否为管理员，这个名字是Django定的。再写<code class="docutils literal notranslate"><span class="pre">views.py</span></code>：</p>
<p><img alt="image79" src="../_images/image-20210306221040923.png" /></p>
<p><code class="docutils literal notranslate"><span class="pre">GenericViewSet</span></code>是Django REST
framework提供了超级封装的类视图，一般不需要重写，给<code class="docutils literal notranslate"><span class="pre">queryset</span></code>和<code class="docutils literal notranslate"><span class="pre">serializer_class</span></code>赋值就可以了。不过因为有些自定义规则，所以本项目进行了复写。<code class="docutils literal notranslate"><span class="pre">permission_classes</span></code>指定了接口访问权限，<code class="docutils literal notranslate"><span class="pre">IsAdminUser</span></code>表示必须管理员才能访问，也是Django定义好的，和前面的<code class="docutils literal notranslate"><span class="pre">is_staff</span></code>相对应：</p>
<p><img alt="image80" src="../_images/image-20210306221332755.png" /></p>
<p>类似的，我在<code class="docutils literal notranslate"><span class="pre">user/permissions.py</span></code>新建了个<code class="docutils literal notranslate"><span class="pre">IsTester</span></code>，用来控制某些功能只能测试使用：</p>
<p><img alt="image81" src="../_images/image-20210306221618430.png" /></p>
<blockquote>
<div><p>本文还用不到这个。</p>
</div></blockquote>
<p>重写查询用户列表<code class="docutils literal notranslate"><span class="pre">list</span></code>方法：</p>
<p><img alt="image82" src="../_images/image-20210306222004255.png" /></p>
<p>增加<code class="docutils literal notranslate"><span class="pre">username</span></code>和<code class="docutils literal notranslate"><span class="pre">nickname</span></code>的模糊查询。</p>
<p>重写新增用户<code class="docutils literal notranslate"><span class="pre">create</span></code>方法：</p>
<p><img alt="image83" src="../_images/image-20210306222230439.png" /></p>
<p>首先写<code class="docutils literal notranslate"><span class="pre">user</span></code>表，根据角色名是否包含管理员，判断是否写<code class="docutils literal notranslate"><span class="pre">is_staff</span></code>字段，接着用入库后产生的<code class="docutils literal notranslate"><span class="pre">user_id</span></code>写<code class="docutils literal notranslate"><span class="pre">user_role</span></code>表。注意最后一行的<code class="docutils literal notranslate"><span class="pre">status</span></code>，新增的话，状态码返回<code class="docutils literal notranslate"><span class="pre">201</span></code>。</p>
<p>重写修改用户的<code class="docutils literal notranslate"><span class="pre">put</span></code>方法：</p>
<p><img alt="image84" src="../_images/image-20210306222542791.png" /></p>
<p>和新增用户的区别在于，更新<code class="docutils literal notranslate"><span class="pre">user_role</span></code>表数据时，需要根据老角色和新角色，比较差异后，添加新增的，删除废旧的。</p>
<p>重写删除用户的<code class="docutils literal notranslate"><span class="pre">delete</span></code>方法：</p>
<p><img alt="image85" src="../_images/image-20210306222849363.png" /></p>
<p>同时删除<code class="docutils literal notranslate"><span class="pre">user</span></code>表和<code class="docutils literal notranslate"><span class="pre">user_role</span></code>表。注意最后一行的<code class="docutils literal notranslate"><span class="pre">status</span></code>，删除的话，状态码返回<code class="docutils literal notranslate"><span class="pre">204</span></code>。</p>
<p>另外还自定义了<code class="docutils literal notranslate"><span class="pre">user_detail</span></code>方法，返回单个用户信息：</p>
<p><img alt="image86" src="../_images/image-20210306223059140.png" /></p>
<p><code class="docutils literal notranslate"><span class="pre">GenericViewSet</span></code>的这些请求方法在<code class="docutils literal notranslate"><span class="pre">user/urls.py</span></code>文件中配置映射关系：</p>
<p><img alt="image87" src="../_images/image-20210306223155180.png" /></p>
<p><code class="docutils literal notranslate"><span class="pre">&lt;int:pk&gt;</span></code>定义了<code class="docutils literal notranslate"><span class="pre">url</span></code>中的整形参数，<code class="docutils literal notranslate"><span class="pre">pk</span></code>为变量名，通过<code class="docutils literal notranslate"><span class="pre">kwargs[&quot;pk&quot;]</span></code>来取。</p>
<p>在新增用户的时候，需要从角色列表中选择角色，需要后端提供这样的接口，使用<code class="docutils literal notranslate"><span class="pre">ListAPIView</span></code>：</p>
<p><img alt="image88" src="../_images/image-20210306223407616.png" /></p>
<p>4行代码搞定一个接口，这就是Django的好处，除了<code class="docutils literal notranslate"><span class="pre">ListAPIView</span></code>，还有<code class="docutils literal notranslate"><span class="pre">CreateAPIView</span></code>、<code class="docutils literal notranslate"><span class="pre">RetrieveAPIView</span></code>、<code class="docutils literal notranslate"><span class="pre">ListCreateAPIView</span></code>等，按需取用。</p>
<p>密码重置接口用<code class="docutils literal notranslate"><span class="pre">APIView</span></code>来实现：</p>
<p><img alt="image89" src="../_images/image-20210306223625706.png" /></p>
<p>定义了<code class="docutils literal notranslate"><span class="pre">put</span></code>方法，从请求<code class="docutils literal notranslate"><span class="pre">url</span></code>中获取参数值<code class="docutils literal notranslate"><span class="pre">user_id</span></code>，查询<code class="docutils literal notranslate"><span class="pre">user</span></code>对象后，调用预置的<code class="docutils literal notranslate"><span class="pre">set_password</span></code>方法，把密码重置为<code class="docutils literal notranslate"><span class="pre">qa123456</span></code>。记得调用<code class="docutils literal notranslate"><span class="pre">user.save()</span></code>把数据更新到数据库。</p>
<p>除了类视图，Django也提供了函数视图，并且Django REST
framework提供了函数视图的方法装饰器，可以像<code class="docutils literal notranslate"><span class="pre">flask</span></code>框架一样，感受写纯后端接口的体验，按这个方法来写修改密码接口：</p>
<p><img alt="image90" src="../_images/image-20210306223944635.png" /></p>
<p><code class="docutils literal notranslate"><span class="pre">&#64;api_view(['PUT'])</span></code>是Django REST
framework提供的方法装饰器。修改密码时，会对<code class="docutils literal notranslate"><span class="pre">jwt</span></code>进行解码，获取到<code class="docutils literal notranslate"><span class="pre">user_id</span></code>，然后检查老密码是否和数据库中的密码<code class="docutils literal notranslate"><span class="pre">hash</span></code>值一致。</p>
</div>
<div class="section" id="id11">
<h2>前后端联调<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h2>
<p>根据以上思路把前后端的代码写完以后，就可以把项目跑起来看看效果了。先启动Django项目：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>python manage.py runserver
</pre></div>
</div>
<p>接着启动Vue项目：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>npm run serve
</pre></div>
</div>
<p>访问：</p>
<p><a class="reference external" href="http://localhost:8080/">http://localhost:8080/</a></p>
<p>就能看到登录页面了，默认超管用户名为<code class="docutils literal notranslate"><span class="pre">admin</span></code>，密码为<code class="docutils literal notranslate"><span class="pre">qa123456</span></code>，登录成功后可以尝试走一遍功能检查下：</p>
<ol class="arabic simple">
<li><p>点击左上角logo，不会出现跳转到空白页。</p></li>
<li><p>点击右上角信息，弹出下拉菜单，分别有修改密码、个人信息、退出登录。</p></li>
<li><p>点击退出，返回登录页，重新登录。</p></li>
<li><p>查询右上角个人信息，包括用户名、昵称、角色。</p></li>
<li><p>通过右上角下拉菜单修改密码，和老密码不匹配会提示修改失败，填写正确信息会修改成功，自动跳转到登录页面重新登录。输入老密码登录失败，输入新密码登录成功。</p></li>
<li><p>新增用户，保持默认密码，新增成功后，用<code class="docutils literal notranslate"><span class="pre">qa123456</span></code>登录成功。</p></li>
<li><p>新增用户，选择自定义密码，新增成功后，用<code class="docutils literal notranslate"><span class="pre">qa123456</span></code>登录失败，用自定义密码登录成功。</p></li>
<li><p>新增用户，分别创建管理员、开发、测试3个角色用户。</p></li>
<li><p>使用新用户登录，管理员用户能登录成功，开发和测试由于没有后台管理权限，点击登录接口后会提示“无菜单权限”。</p></li>
<li><p>修改用户，修改用户名、密码，修改测试角色用户为管理员角色，重新登录，能看到用户名、密码已更新为修改后的用户名、密码，并且管理员角色生效，能登进去看到后台管理功能。</p></li>
<li><p>输入用户名或昵称，点击搜索按钮，测试模糊查询功能正常，重置后清空搜索框，自动查询一次列表。</p></li>
<li><p>点击删除按钮，提示是否确认删除，确认后删除成功，检查数据库<code class="docutils literal notranslate"><span class="pre">user_role</span></code>表数据也被清理干净。</p></li>
<li><p>切换分页，刷新列表，选择不同分页条数，正常计算显示相应的分页总数。</p></li>
<li><p>找到自定义密码的用户，点击重置密码，重置成功后，重新登录，使用自定义密码登录失败，使用默认密码<code class="docutils literal notranslate"><span class="pre">qa123456</span></code>登录成功。</p></li>
<li><p>点击左侧菜单旁边的面包屑按钮，能收起和展开左侧菜单。</p></li>
</ol>
<blockquote>
<div><p>由于时间关系，目前还没有做角色管理功能，角色通过后端Django的<code class="docutils literal notranslate"><span class="pre">fixtures/user.json</span></code>进行数据初始化。</p>
</div></blockquote>
</div>
<div class="section" id="postmanmock-server">
<h2>Postman搭建Mock Server<a class="headerlink" href="#postmanmock-server" title="Permalink to this headline">¶</a></h2>
<p>在写前端代码过程中，后端还没有写好，可以找一个服务模拟后端，提供响应数据进行前端调试，这项技术叫做Mock，这个服务称为Mock
Server。Mock
Server可以使用JavaScript的<code class="docutils literal notranslate"><span class="pre">mock.js</span></code>来搭建，也可以使用Python的<code class="docutils literal notranslate"><span class="pre">FastAPI</span></code>，不嫌麻烦用<code class="docutils literal notranslate"><span class="pre">Spring</span> <span class="pre">Boot</span></code>或者<code class="docutils literal notranslate"><span class="pre">Nginx</span></code>做一个也可以。不过为了方便起见，选择上手就能用的可以省不少心。一些网站会提供在线Mock服务，在网站上填写<code class="docutils literal notranslate"><span class="pre">url</span></code>和<code class="docutils literal notranslate"><span class="pre">response</span> <span class="pre">body</span></code>，有个缺点是我找了一圈都没有发现能设置响应状态码的，比如在调试<code class="docutils literal notranslate"><span class="pre">axios.js</span></code>的响应拦截器时，就需要根据<code class="docutils literal notranslate"><span class="pre">404</span></code>、<code class="docutils literal notranslate"><span class="pre">500</span></code>来进行调试，看效果。寻寻觅觅，发现平时都在用的Postman，直接可以做Mock
Server。首先登陆Postman，只有登陆后才能使用这个功能：</p>
<p><img alt="image91" src="../_images/image-20210307081648583.png" /></p>
<p>可以选择用Google账号登陆，也可以注册一个。点击左上角<code class="docutils literal notranslate"><span class="pre">+</span> <span class="pre">New</span></code>：</p>
<p><img alt="image92" src="../_images/image-20210307081809305.png" /></p>
<p>选择<code class="docutils literal notranslate"><span class="pre">Mock</span> <span class="pre">Server</span></code>。依次填写请求方法、请求路径、响应状态码、响应体：</p>
<p><img alt="image93" src="../_images/image-20210307083024981.png" /></p>
<p>点击表格右上角的三个点还能添加请求体和接口描述：</p>
<p><img alt="image94" src="../_images/image-20210307082202812.png" /></p>
<p>接着点击下一步：</p>
<p><img alt="image95" src="../_images/image-20210307082306604.png" /></p>
<p>填写Mock
Server的名字为<code class="docutils literal notranslate"><span class="pre">hello</span></code>，其他选项默认，点击<code class="docutils literal notranslate"><span class="pre">Create</span> <span class="pre">Mock</span> <span class="pre">Server</span></code>进行创建：</p>
<p><img alt="image96" src="../_images/image-20210307082424949.png" /></p>
<p>关闭后，Mock Server就建好了：</p>
<p><img alt="image97" src="../_images/image-20210307082635515.png" /></p>
<p>接着从左侧<code class="docutils literal notranslate"><span class="pre">Collections</span></code>中找到这个接口，点击打开：</p>
<p><img alt="image98" src="../_images/image-20210307083150463.png" /></p>
<p>此时还不能发送请求，需要在右上角选择环境<code class="docutils literal notranslate"><span class="pre">hello</span></code>：</p>
<p><img alt="image99" src="../_images/image-20210307083317580.png" /></p>
<p>发送请求成功：</p>
<p><img alt="image100" src="../_images/image-20210307083359324.png" /></p>
<p>其中<code class="docutils literal notranslate"><span class="pre">url</span></code>是隐藏了的，点击右上角环境旁边的眼睛图标查看：</p>
<p><img alt="image101" src="../_images/image-20210307083509730.png" /></p>
<p>修改已创建接口mock数据的入口在<code class="docutils literal notranslate"><span class="pre">Examples</span></code>：</p>
<p><img alt="image102" src="../_images/image-20210307083835208.png" /></p>
<p>点击<code class="docutils literal notranslate"><span class="pre">Default</span></code>：</p>
<p><img alt="image103" src="../_images/image-20210307083935109.png" /></p>
<p>提供了新增时更直观的操作界面，比如我把响应状态码改成了<code class="docutils literal notranslate"><span class="pre">404</span></code>，响应体改成了<code class="docutils literal notranslate"><span class="pre">{&quot;msg&quot;:</span> <span class="pre">&quot;hello</span> <span class="pre">not</span> <span class="pre">found&quot;}</span></code>，点击右上角<code class="docutils literal notranslate"><span class="pre">Save</span> <span class="pre">Example</span></code>保存后，再次请求：</p>
<p><img alt="image104" src="../_images/image-20210307084138020.png" /></p>
<p>实际mock的状态码和响应体也更新了。</p>
</div>
<div class="section" id="id12">
<h2>小结<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h2>
<p>本文是学习版pytest内核测试平台开发的入门篇，内容比较充实，全文字数上万，一共截了103张图，借助<code class="docutils literal notranslate"><span class="pre">FastStone</span> <span class="pre">Capture</span></code>这个小工具，还算轻松，希望能让读者更直观的看到平台功能和代码逻辑。“编写Vue代码”和“编写Django代码”2个小节的内容是一气呵成写完的，没有做修改，怕改了之后反而影响行文思路，不够畅快。前端项目参考了一些开源项目如<code class="docutils literal notranslate"><span class="pre">Tcloud</span></code>、<code class="docutils literal notranslate"><span class="pre">FasterRunner</span></code>等，把代码看懂后，自己重新组织了代码和规范，在调试过程中，也学会了写Vue，做学习版<code class="docutils literal notranslate"><span class="pre">teprunner</span></code>时就从头写了一遍。后端代码完全是我自己写的，先学了一遍Django和Django
REST
framework官方教程，其中《Django认证系统并不鸡肋反而很重要》这篇文章在腾讯云+社区2020年度征文活动中，被评选为了最受喜爱作者奖，如果对Django认证系统不是很清楚的话，可以看看。最后，个人水平有限，有错误或不足之处，还请见谅。虽然测试平台不一定能完全落地，但是做一遍开发对能力的提升是极大的。<code class="docutils literal notranslate"><span class="pre">teprunner</span></code>并不算优秀平台，和真正企业级项目比起来，就是个小玩具。如果能博君一乐，也算是体现价值了。</p>
<blockquote>
<div><p>参考资料：</p>
<p>源码前端 <a class="reference external" href="https://github.com/dongfanger/teprunner-frontend">https://github.com/dongfanger/teprunner-frontend</a></p>
<p>源码后端 <a class="reference external" href="https://github.com/dongfanger/teprunner-backend">https://github.com/dongfanger/teprunner-backend</a></p>
<p>个人博客 <a class="reference external" href="https://dongfanger.gitee.io/blog/">https://dongfanger.gitee.io/blog/</a></p>
</div></blockquote>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="003-teprunner%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0%E9%83%A8%E7%BD%B2%E5%88%B0Linux%E7%B3%BB%E7%BB%9FDocker.html" class="btn btn-neutral float-right" title="3 teprunner测试平台部署到Linux系统Docker" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="001-pytest%E5%86%85%E6%A0%B8%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0%E8%90%BD%E5%9C%B0%E5%88%9D%E4%BD%93%E9%AA%8C.html" class="btn btn-neutral float-left" title="1 pytest内核测试平台落地初体验" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright dongfanger

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>