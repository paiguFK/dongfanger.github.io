

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>4 teprunner测试平台用例前置模块开发 &mdash; dongfanger latest documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/js/readmore.js"></script>
        <script src="../_static/js/baidutongji.js"></script>
        <script src="../_static/js/valine.js"></script>
        <script src="../_static/js/Valine.min.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="5 teprunner测试平台开发用例管理不只有增删改查" href="005-teprunner%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0%E5%BC%80%E5%8F%91%E7%94%A8%E4%BE%8B%E7%AE%A1%E7%90%86%E4%B8%8D%E5%8F%AA%E6%9C%89%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5.html" />
    <link rel="prev" title="3 teprunner测试平台部署到Linux系统Docker" href="003-teprunner%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0%E9%83%A8%E7%BD%B2%E5%88%B0Linux%E7%B3%BB%E7%BB%9FDocker.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> dongfanger
          

          
          </a>

          
            
            
              <div class="version">
                latest
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../preface.html">前言</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/Python%E5%85%A5%E9%97%A8.html">Python入门</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/Python%E8%BF%9B%E9%98%B6.html">Python进阶</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/pytest%E5%8E%9F%E7%94%9F%E6%A1%86%E6%9E%B6.html">pytest原生框架</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/tep%E5%BC%80%E6%BA%90%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7.html">tep开源测试工具</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../chapters/teprunner%E5%BC%80%E6%BA%90%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0.html">teprunner开源测试平台</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="001-pytest%E5%86%85%E6%A0%B8%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0%E8%90%BD%E5%9C%B0%E5%88%9D%E4%BD%93%E9%AA%8C.html">1 pytest内核测试平台落地初体验</a></li>
<li class="toctree-l2"><a class="reference internal" href="002-%E5%AD%A6%E4%B9%A0%E7%89%88pytest%E5%86%85%E6%A0%B8%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0%E5%BC%80%E5%8F%91%E4%B8%87%E5%AD%97%E9%95%BF%E6%96%87%E5%85%A5%E9%97%A8%E7%AF%87.html">2 学习版pytest内核测试平台开发万字长文入门篇</a></li>
<li class="toctree-l2"><a class="reference internal" href="003-teprunner%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0%E9%83%A8%E7%BD%B2%E5%88%B0Linux%E7%B3%BB%E7%BB%9FDocker.html">3 teprunner测试平台部署到Linux系统Docker</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">4 teprunner测试平台用例前置模块开发</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">本文开发内容</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">编写后端代码</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">编写前端代码</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">小结</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="005-teprunner%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0%E5%BC%80%E5%8F%91%E7%94%A8%E4%BE%8B%E7%AE%A1%E7%90%86%E4%B8%8D%E5%8F%AA%E6%9C%89%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5.html">5 teprunner测试平台开发用例管理不只有增删改查</a></li>
<li class="toctree-l2"><a class="reference internal" href="006-teprunner%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0Django%E5%BC%95%E5%85%A5pytest%E5%AE%8C%E6%95%B4%E6%BA%90%E7%A0%81.html">6 teprunner测试平台Django引入pytest完整源码</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/Django.html">Django</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/Django%20REST%20framework.html">Django REST framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/%E5%88%86%E5%89%B2%E7%BA%BF.html">————————————</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/Java%E5%85%A5%E9%97%A8.html">Java入门</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/JMeter.html">JMeter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C.html">实战经验</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/%E5%B9%B4%E5%BA%A6%E6%80%BB%E7%BB%93.html">年度总结</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/%E6%88%90%E9%95%BF%E5%B0%8F%E8%AF%B4.html">成长小说</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/%E9%9D%A2%E8%AF%95%E9%A2%98.html">面试题</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aboutme.html">关于作者</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contact.html">联系</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">dongfanger</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../chapters/teprunner%E5%BC%80%E6%BA%90%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0.html">teprunner开源测试平台</a> &raquo;</li>
        
      <li>4 teprunner测试平台用例前置模块开发</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/teprunner开源测试平台/004-teprunner测试平台用例前置模块开发.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="teprunner">
<h1>4 teprunner测试平台用例前置模块开发<a class="headerlink" href="#teprunner" title="Permalink to this headline">¶</a></h1>
<p><img alt="image1" src="../_images/wanggang7.png" /></p>
<div class="section" id="id1">
<h2>本文开发内容<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>现在正式进入测试相关功能开发。teprunner测试平台底层是pytest，中间层是tep，还没了解的朋友可以先看看tep的文章，整个平台的设计思路和后面用例的执行都会基于这个工具。tep的测试用例是放在.py文件里面的，全局变量或者说环境变量是引用的env_vars，公共函数和复用接口是引用的fixtures，在做成平台后，需要把这两个部分独立为两个功能模块。多个项目的接口自动化数据需要隔离开来，要有个项目管理功能。本文将开发四个用例前置模块：</p>
<ul class="simple">
<li><p>后台管理–项目管理</p></li>
<li><p>接口自动化–语法说明</p></li>
<li><p>接口自动化–环境变量</p></li>
<li><p>接口自动化–fixtures</p></li>
</ul>
<blockquote>
<div><p>语法说明给出了环境变量、fixtures、用例示例（单个接口、多个接口–增删改查）、请求方法（get、post、put、delete）的使用方法。</p>
</div></blockquote>
</div>
<div class="section" id="id2">
<h2>编写后端代码<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>先创建名为teprunner的app：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>django-admin startapp teprunner
</pre></div>
</div>
<p>在settings的INSTALLED_APPS中添加配置让app生效：</p>
<p><img alt="image2" src="../_images/image-20210319102357847.png" /></p>
<p>并在urls.py添加路由：</p>
<p><img alt="image3" src="../_images/image-20210319102448253.png" /></p>
<p>编辑user/fixtures/user.json，添加一个接口自动化的菜单：</p>
<p><img alt="image4" src="../_images/image-20210319102641109.png" /></p>
<p>截图只截了管理员，测试和开发角色，也需要添加上。access均为true，这三个角色都可以访问。添加后把数据同步到数据库：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>python manage.py loaddata user
</pre></div>
</div>
<p>编辑teprunner/models.py，新增模型：</p>
<p><img alt="image5" src="../_images/image-20210319103054973.png" /></p>
<p>包括了项目、环境变量和fixture三张表。Project.env_config用于给项目配置多个环境。不同项目不同环境的环境变量不一样，在EnvVar中添加了project_id和env_name，并按(“project_id”,
“env_name”,
“name”)作为唯一键，不允许重复。不同项目的fixtures不同，不关心环境，在Fixture中只添加了project_id。</p>
<blockquote>
<div><p>Fixture.code用于存放代码，字段类型为models.TextField，容纳更多字符。</p>
</div></blockquote>
<p>models编写好后，迁移到数据库：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>python manage.py makemigrations
python manage.py migrate
</pre></div>
</div>
<p>新建teprunner/serializers.py文件，新增序列化器：</p>
<p><img alt="image6" src="../_images/image-20210319104338876.png" /></p>
<p>数据库字段的命名是用的下划线，接口返回前端和前端传参是用的驼峰，所以这里通过source这种方式给env_config、project_id、env_name、creator_nickname进行了序列化器的重命名。为了前端更方便处理，使用serializers.CharField把int转化为了str，由于请求时id非必须，增加参数required=False。</p>
<p>teprunner会有很多视图，写在一个文件里面有点臃肿，这里创建views文件夹，新增views/project.py项目视图：</p>
<p><img alt="image7" src="../_images/image-20210319104708429.png" /></p>
<p>Django REST
framework的ModelViewSet视图类能节省很多代码，只需要三行就把项目增删改查接口做了。project_env是函数视图，请求方法为GET，它的作用是返回项目环境列表，当前项目和当前环境，默认为第一个项目和第一个环境。</p>
<blockquote>
<div><p>前端需要切换不同项目和不同环境，下拉框数据来源于这个接口。</p>
</div></blockquote>
<p>新建views/envvar.py新增环境变量视图：</p>
<p><img alt="image8" src="../_images/image-20210319105055900.png" /></p>
<p>环境变量跟项目和环境是强关联的，需要根据项目环境进行过滤，所以重写了list方法，从前端请求拿到curProjectId和curEnvName，通过EnvVar.objects.filter进行过滤。<code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">django.db.models</span> <span class="pre">import</span> <span class="pre">Q</span></code>支持多种过滤条件，这在后面的代码中还能看到，比如模糊匹配。</p>
<p>新建views/fixture.py新增fixture视图：</p>
<p><img alt="image9" src="../_images/image-20210319105408572.png" /></p>
<p>fixture跟项目是强关联的，需要根据项目进行过滤，所以重写了list方法，从前端请求拿到curProjectId，通过Fixture.objects.filter进行过滤。Fixture有个creatorNickname字段，新增fixture时使用的是当前登录用户的昵称，修改fixture时需要用已保存的创建者，重写update方法来实现这个处理。</p>
<p>最后，新建teprunner/urls.py文件，把视图添加到路由中：</p>
<p><img alt="image10" src="../_images/image-20210319105828631.png" /></p>
</div>
<div class="section" id="id3">
<h2>编写前端代码<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>编辑package.json，添加依赖：</p>
<p><img alt="image11" src="../_images/image-20210319110007349.png" /></p>
<p>fixtures是代码形式的，这是测试平台第一次使用代码编辑组件。添加依赖后记得执行<code class="docutils literal notranslate"><span class="pre">npm</span> <span class="pre">install</span></code>进行安装。</p>
<p>编辑router/index.js：</p>
<p><img alt="image12" src="../_images/image-20210319110310618.png" /></p>
<p>添加接口自动化的路由，并把home重定向改为语法说明路由。children表示子路由。path是路由地址。meta.title用于显示菜单名。</p>
<p>编辑views/console/index.vue：</p>
<p><img alt="image13" src="../_images/image-20210319110627087.png" /></p>
<p>添加项目管理菜单。新建ProjectManagement.vue和AddProject.vue，添加项目管理增删改查代码，跟用户管理类似，不再另加赘述。值得注意的是环境配置<code class="docutils literal notranslate"><span class="pre">placeholder=&quot;请输入环境英文名（多个环境英文逗号分隔）&quot;</span></code>，因为tep.env_vars.mapping会用到环境名作为key，所以只能用英文名！</p>
<p>编辑components/WrapComponent.vue，添加一个插槽：</p>
<p><img alt="image14" src="../_images/image-20210319111320242.png" /></p>
<p>用于切换项目和环境。新建components/ProjectEnv.vue文件：</p>
<p><img alt="image15" src="../_images/image-20210319111519429.png" /></p>
<p>定义了两个下拉框：项目和环境。v-if判断是否需要显示。&#64;change在切换下拉选项时调用对应方法。&#64;click.native指在点击打开时获取数据。然后用v-for遍历列表展示下拉选项。环境和项目数据是从localStorage中读取的：</p>
<p><img alt="image16" src="../_images/image-20210319111749842.png" /></p>
<p>可以打开F12切换到Application，点击左侧Storage/Local
Storage检查是否有数据：</p>
<p><img alt="image17" src="../_images/image-20210319112019574.png" /></p>
<p>数据写入的地方稍后会讲到，先接着讲ProjectEnv.vue文件：</p>
<p><img alt="image18" src="../_images/image-20210319112202866.png" /></p>
<p>切换项目会更新环境列表和当前环境数据，这样就把这两个下拉框关联了起来。切换环境会更新当前环境数据。图中框起来的<code class="docutils literal notranslate"><span class="pre">this.$emit</span></code>是个重要知识点。ProjectEnv.vue是个子组件，它是要嵌套到其他组件去的，比如EnvVar.vue，它们是父子组件的关系。有这么个需求，切换项目时，执行一次查询操作，把查询结果更新一下。切换项目的代码是ProjectEnv.vue子组件提供的，执行查询操作的代码是EnvVar.vue父组件提供的，子组件就是通过<code class="docutils literal notranslate"><span class="pre">this.$emit</span></code>把这个消息通知给父组件的。</p>
<p>新建views/teprunner/index.vue文件，添加接口自动化菜单：</p>
<p><img alt="image19" src="../_images/image-20210319113008688.png" /></p>
<p>刚才说的项目环境数据的写入就是在这里进行的：</p>
<p><img alt="image20" src="../_images/image-20210319113050691.png" /></p>
<p>每次加载时，如果localStorage没有projectEnvList的话，就请求<code class="docutils literal notranslate"><span class="pre">/teprunner/projects/env</span></code>去拿。</p>
<p>新建Grammar.vue，语法说明是个硬编码的静态文件，纯展示，无交互。接着新建EnvVar.vue和AddEnvVar.vue，编写环境变量的增删改查，新建Fixture.vue和AddFixture.vue，编写fixtures的增删改查，比较类似，不再另加赘述。通过fixtures模块的代码，看看ProjectEnv.vue是如何用的：</p>
<p><img alt="image21" src="../_images/image-20210319113554291.png" /></p>
<p>:showEnv与ProjectEnv.vue子组件的属性对应，用来控制是否显示环境，Fxiture不需要显示。&#64;changeProject与ProjectEnv.vue的this.$emit对应，接收子组件消息，执行查询列表操作：</p>
<p><img alt="image22" src="../_images/image-20210319113817677.png" /></p>
<p>AddFixture.vue用到了代码编辑器：</p>
<p><img alt="image23" src="../_images/image-20210319113952344.png" /></p>
<p>&#64;init指定了初始化方法：</p>
<p><img alt="image24" src="../_images/image-20210319114017565.png" /></p>
<p>离代码完美显示还差最后一步：代码高亮。在assets/js添加<code class="docutils literal notranslate"><span class="pre">highlight.js</span></code>，并在main.js中导入：</p>
<p><img alt="image25" src="../_images/image-20210319114256109.png" /></p>
</div>
<div class="section" id="id4">
<h2>小结<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p>经过本文的开发，如何添加菜单，前后端如何完成基本的增删改查开发已经进行了很充分的展示。遇到不会写的代码，也都能从已公开源码中找到参考。行动起来吧！边学边练，动手试试把用例管理的增删改查写出来，等我把下一篇写出来后，比较比较，可能会有更深刻的印象。CRUD会了，定制化开发还会远么。</p>
<blockquote>
<div><p>参考资料：</p>
<p>前端源码 <a class="reference external" href="https://github.com/dongfanger/teprunner-frontend">https://github.com/dongfanger/teprunner-frontend</a></p>
<p>后端源码 <a class="reference external" href="https://github.com/dongfanger/teprunner-backend">https://github.com/dongfanger/teprunner-backend</a></p>
</div></blockquote>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="005-teprunner%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0%E5%BC%80%E5%8F%91%E7%94%A8%E4%BE%8B%E7%AE%A1%E7%90%86%E4%B8%8D%E5%8F%AA%E6%9C%89%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5.html" class="btn btn-neutral float-right" title="5 teprunner测试平台开发用例管理不只有增删改查" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="003-teprunner%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0%E9%83%A8%E7%BD%B2%E5%88%B0Linux%E7%B3%BB%E7%BB%9FDocker.html" class="btn btn-neutral float-left" title="3 teprunner测试平台部署到Linux系统Docker" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright dongfanger

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>