

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>4 Django认证系统并不鸡肋反而很重要 &mdash; dongfanger latest documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/js/readmore.js"></script>
        <script src="../_static/js/baidutongji.js"></script>
        <script src="../_static/js/valine.js"></script>
        <script src="../_static/js/Valine.min.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="5 自定义Django认证系统的技术方案" href="005-%E8%87%AA%E5%AE%9A%E4%B9%89Django%E8%AE%A4%E8%AF%81%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88.html" />
    <link rel="prev" title="3 Django官方为什么没有标准项目结构" href="003-Django%E5%AE%98%E6%96%B9%E4%B8%BA%E4%BB%80%E4%B9%88%E6%B2%A1%E6%9C%89%E6%A0%87%E5%87%86%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> dongfanger
          

          
          </a>

          
            
            
              <div class="version">
                latest
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../preface.html">前言</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/Python%E5%85%A5%E9%97%A8.html">Python入门</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/Python%E8%BF%9B%E9%98%B6.html">Python进阶</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/pytest%E5%8E%9F%E7%94%9F%E6%A1%86%E6%9E%B6.html">pytest原生框架</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/tep%E5%BC%80%E6%BA%90%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7.html">tep开源测试工具</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/teprunner%E5%BC%80%E6%BA%90%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0.html">teprunner开源测试平台</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../chapters/Django.html">Django</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="001-Django%E5%8C%86%E5%8C%86%E4%B8%80%E7%9C%BC%E5%8D%B4%E8%A7%A3%E7%AD%94%E4%BA%86%E5%A4%9A%E5%B9%B4%E7%96%91%E6%83%91.html">1 Django匆匆一眼却解答了多年疑惑</a></li>
<li class="toctree-l2"><a class="reference internal" href="002-Django%E6%90%AD%E5%BB%BA%E7%A4%BA%E4%BE%8B%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B8%8E%E9%81%BF%E5%9D%91%E7%BB%86%E8%8A%82.html">2 Django搭建示例项目实战与避坑细节</a></li>
<li class="toctree-l2"><a class="reference internal" href="003-Django%E5%AE%98%E6%96%B9%E4%B8%BA%E4%BB%80%E4%B9%88%E6%B2%A1%E6%9C%89%E6%A0%87%E5%87%86%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84.html">3 Django官方为什么没有标准项目结构</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">4 Django认证系统并不鸡肋反而很重要</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">安装</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">认证与授权</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">认证系统概览</a></li>
<li class="toctree-l3"><a class="reference internal" href="#models-user">models.User</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id4">创建超级管理员</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">创建用户</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">修改密码</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">用户认证</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">认证后端</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id9">权限管理</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id10">默认权限</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id11">创建新权限</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id12">授权</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id13">代理模型权限</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#session">Session认证</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id14">用户登录</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id15">用户登出</a></li>
<li class="toctree-l4"><a class="reference internal" href="#login-required">login_required</a></li>
<li class="toctree-l4"><a class="reference internal" href="#function-viewsclass-based-views"><strong>function views和class-based views</strong></a></li>
<li class="toctree-l4"><a class="reference internal" href="#loginrequiredmixin">LoginRequiredMixin</a></li>
<li class="toctree-l4"><a class="reference internal" href="#permission-required">permission_required</a></li>
<li class="toctree-l4"><a class="reference internal" href="#permissionrequiredmixin">PermissionRequiredMixin</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id16">修改密码导致session失效</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id17">认证视图</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id18">快速上手体验</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id19">小结</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="005-%E8%87%AA%E5%AE%9A%E4%B9%89Django%E8%AE%A4%E8%AF%81%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88.html">5 自定义Django认证系统的技术方案</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/Django%20REST%20framework.html">Django REST framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/%E5%B9%B4%E5%BA%A6%E6%80%BB%E7%BB%93.html">年度总结</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/Java%E5%85%A5%E9%97%A8.html">Java入门</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/JMeter.html">JMeter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C.html">实战经验</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/%E9%9D%A2%E8%AF%95%E9%A2%98.html">面试题</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/%E6%88%90%E9%95%BF%E5%B0%8F%E8%AF%B4%E7%8B%AC%E5%AE%B6%E8%BF%9E%E8%BD%BD.html">成长小说独家连载</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aboutme.html">关于作者</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">dongfanger</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../chapters/Django.html">Django</a> &raquo;</li>
        
      <li>4 Django认证系统并不鸡肋反而很重要</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/Django/004-Django认证系统并不鸡肋反而很重要.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="django">
<h1>4 Django认证系统并不鸡肋反而很重要<a class="headerlink" href="#django" title="Permalink to this headline">¶</a></h1>
<p><img alt="image1" src="../_images/wanggang1.png" /></p>
<p>在使用<code class="docutils literal notranslate"><span class="pre">django-admin</span> <span class="pre">startproject</span></code>创建项目后，Django就默认安装了一个采用session实现的认证系统。这是Django相比于其他框架的一大特点：自带认证系统，开箱即用。有人说它方便，有人说它鸡肋，但它作为Django的重要组成部分，学习它有助于我们理解Django框架的核心技术。</p>
<div class="section" id="id1">
<h2>安装<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>Django默认已安装，可以在<code class="docutils literal notranslate"><span class="pre">settings.py</span></code>中的<code class="docutils literal notranslate"><span class="pre">INSTALLED_APPS</span></code>看到：</p>
<ul class="simple">
<li><p>django.contrib.auth：认证系统内核，以及默认models等。</p></li>
<li><p>django.contrib.contenttypes：用于关联权限和models，从而赋予models的添加/删除等权限。</p></li>
</ul>
<blockquote>
<div><p>contrib翻译为普通发布版。</p>
</div></blockquote>
<p>在<code class="docutils literal notranslate"><span class="pre">MIDDLEWARE</span></code>可以看到：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SessionMiddleware</span></code>：session中间件。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AuthenticationMiddleware</span></code>：认证中间件。</p></li>
</ul>
<p>使用<code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">migrate</span></code>后，数据库会新增认证系统的这些表：</p>
<p><img alt="image2" src="../_images/image-20201203153918381.png" /></p>
</div>
<div class="section" id="id2">
<h2>认证与授权<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>认证的英文是authentication，授权的英文是authorization。单词不一样，咋看有点像。认证是指验证用户是谁。授权是指授予已认证用户权限。由于认证授权在某种程序上是耦合的，所以Django把它们统称为“认证”。</p>
</div>
<div class="section" id="id3">
<h2>认证系统概览<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>认证系统的组成部分如下：</p>
<ul class="simple">
<li><p>用户</p></li>
<li><p>权限</p></li>
<li><p>组</p></li>
<li><p>密码管理</p></li>
<li><p>登录相关表单（前后端分离不需要）和视图（接受Web请求并且返回Web响应）</p></li>
</ul>
<blockquote>
<div><p>Django框架是MTV模式，类似于MVC模式。Django的View对应MVC的Controller。</p>
</div></blockquote>
<ul class="simple">
<li><p>可配置的backend</p></li>
</ul>
<p>以上是Django自带内容，如果需要更多功能，可以安装第三方包：</p>
<ul class="simple">
<li><p>密码增强校验</p></li>
<li><p>登录限流</p></li>
<li><p>OAuth</p></li>
<li><p>对象级权限（django-guardian）</p></li>
</ul>
<blockquote>
<div><p>以Article举例，Django是模型级权限，用户只能具有全部文章的权限。django-guardian提供了对象级权限，可以对单篇文章进行授权。</p>
</div></blockquote>
</div>
<div class="section" id="models-user">
<h2>models.User<a class="headerlink" href="#models-user" title="Permalink to this headline">¶</a></h2>
<p>User模型是Django认证系统的核心，它的主要属性包括：</p>
<ul class="simple">
<li><p>id</p></li>
<li><p>username</p></li>
<li><p>email</p></li>
<li><p>password</p></li>
<li><p>is_active</p></li>
<li><p>is_superuser</p></li>
<li><p>last_login</p></li>
<li><p>date_joined</p></li>
</ul>
<blockquote>
<div><p>django.contrib.auth.models，在django.db.models之上封装了AbstractBaseUser、AbstractUser、User等模型。</p>
</div></blockquote>
<div class="section" id="id4">
<h3>创建超级管理员<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>cmd中使用<code class="docutils literal notranslate"><span class="pre">createsuperuser</span></code>命令：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ python manage.py createsuperuser
</pre></div>
</div>
<p>根据提示输入username、email、password后，就会在数据库中创建1条超管用户。</p>
</div>
<div class="section" id="id5">
<h3>创建用户<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p><strong>方法1 代码创建</strong></p>
<p>在代码中使用<code class="docutils literal notranslate"><span class="pre">create_user()</span></code>函数来创建用户：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; from django.contrib.auth.models import User
<span class="c1"># 创建用户并保存到数据库</span>
&gt;&gt;&gt; <span class="nv">user</span> <span class="o">=</span> User.objects.create_user<span class="o">(</span><span class="s1">&#39;john&#39;</span>, <span class="s1">&#39;lennon@thebeatles.com&#39;</span>, <span class="s1">&#39;johnpassword&#39;</span><span class="o">)</span>


<span class="c1"># 修改其他字段值</span>
&gt;&gt;&gt; user.last_name <span class="o">=</span> <span class="s1">&#39;Lennon&#39;</span>
&gt;&gt;&gt; user.save<span class="o">()</span>
</pre></div>
</div>
<p><strong>方法2 管理后台创建</strong></p>
<p>访问<code class="docutils literal notranslate"><span class="pre">http://127.0.0.1:8000/admin/</span></code>，用超管登录后，在界面上创建：</p>
<p><img alt="image3" src="../_images/image-20201209211840384.png" /></p>
</div>
<div class="section" id="id6">
<h3>修改密码<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p><strong>方法1 命令行修改</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">changepassword</span> <span class="n">username</span>
</pre></div>
</div>
<p>根据提示输入旧密码、新密码、确认密码即可。</p>
<p><strong>方法2 代码中修改</strong></p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; from django.contrib.auth.models import User
&gt;&gt;&gt; <span class="nv">u</span> <span class="o">=</span> User.objects.get<span class="o">(</span><span class="nv">username</span><span class="o">=</span><span class="s1">&#39;john&#39;</span><span class="o">)</span>
&gt;&gt;&gt; u.set_password<span class="o">(</span><span class="s1">&#39;new password&#39;</span><span class="o">)</span>
&gt;&gt;&gt; u.save<span class="o">()</span>
</pre></div>
</div>
<p><strong>方法3 管理后台修改</strong></p>
<p><img alt="image4" src="../_images/image-20201210111841443.png" /></p>
<p><img alt="image5" src="../_images/image-20201210111909935.png" /></p>
</div>
<div class="section" id="id7">
<h3>用户认证<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>框架底层使用<code class="docutils literal notranslate"><span class="pre">authenticate()</span></code>函数对用户进行认证：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">authenticate</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">credentials</span><span class="p">)</span>
</pre></div>
</div>
<p>credentials是用户凭证，如用户名、密码。</p>
<p>示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">authenticate</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">authenticate</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;john&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;secret&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># A backend authenticated the credentials</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># No backend authenticated the credentials</span>
</pre></div>
</div>
<p>如果认证成功，<code class="docutils literal notranslate"><span class="pre">authenticate()</span></code>会返回User。如果用户凭证无效或者权限不足，认证后端抛出了PermissionDenied，<code class="docutils literal notranslate"><span class="pre">authenticate()</span></code>会返回None。</p>
</div>
<div class="section" id="id8">
<h3>认证后端<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p>认证后端（authentication
backends）是Django做用户验证的后端模块，默认为<code class="docutils literal notranslate"><span class="pre">['django.contrib.auth.backends.ModelBackend']</span></code>，只会简单比较请求的用户名密码和数据库中的用户名密码是否匹配。可以切换成其他认证后端，也可以重写<code class="docutils literal notranslate"><span class="pre">authenticate()</span></code>进行自定义。我点开了源码，发现除了Django的认证后端，DRF已经封装了Session、Token、JWT的认证：</p>
<p><img alt="image6" src="../_images/image-20201210125001757.png" /></p>
</div>
</div>
<div class="section" id="id9">
<h2>权限管理<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h2>
<p>权限一般分为add、change、delete、view，也就是增删改查。</p>
<div class="section" id="id10">
<h3>默认权限<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<p>Django会在<code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">migrate</span></code>的时候，为每个model创建4种权限：add、change、delete、view。</p>
<p>比如有个app叫做foo，它有个model叫做Bar，可以使用<code class="docutils literal notranslate"><span class="pre">has_perm()</span></code>函数来检查权限：</p>
<ul class="simple">
<li><p>add：user.has_perm(‘foo.add_bar’)</p></li>
<li><p>change：user.has_perm(‘foo.change_bar’)</p></li>
<li><p>delete：user.has_perm(‘foo.delete_bar’)</p></li>
<li><p>view：user.has_perm(‘foo.view_bar’)</p></li>
</ul>
</div>
<div class="section" id="id11">
<h3>创建新权限<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h3>
<p>除了增删改查权限，有时我们需要更多的权限，例如，为myapp中的BlogPost创建一个can_publish权限：</p>
<p><strong>方法1 meta中配置</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BlogPost</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">permissions</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;can_publish&quot;</span><span class="p">,</span> <span class="s2">&quot;Can Publish Posts&quot;</span><span class="p">),</span>
        <span class="p">)</span>
</pre></div>
</div>
<p><strong>方法2 使用``create()``函数</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">myapp.models</span> <span class="kn">import</span> <span class="n">BlogPost</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">Permission</span>
<span class="kn">from</span> <span class="nn">django.contrib.contenttypes.models</span> <span class="kn">import</span> <span class="n">ContentType</span>

<span class="n">content_type</span> <span class="o">=</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_for_model</span><span class="p">(</span><span class="n">BlogPost</span><span class="p">)</span>
<span class="n">permission</span> <span class="o">=</span> <span class="n">Permission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
    <span class="n">codename</span><span class="o">=</span><span class="s1">&#39;can_publish&#39;</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Can Publish Posts&#39;</span><span class="p">,</span>
    <span class="n">content_type</span><span class="o">=</span><span class="n">content_type</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>在使用<code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">migrate</span></code>命令后，就会创建这个新权限，接着就可以在view中编写代码判断用户是否有这个权限来决定能否发表文章。</p>
</div>
<div class="section" id="id12">
<h3>授权<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<p>可以在管理后台对用户授权：</p>
<p><img alt="image7" src="../_images/image-20201210132644755.png" /></p>
<p>或者把用户分组后，按组来进行授权：</p>
<p><img alt="image8" src="../_images/image-20201210152354130.png" /></p>
<p>从数据库这6张表就能看出来，有用户表、分组表、权限表，以及它们的关联关系表：</p>
<p><img alt="image9" src="../_images/image-20201210140810333.png" /></p>
<p>其代码实现是把permission赋值给User.user_permissions或者Group.permissions属性。</p>
</div>
<div class="section" id="id13">
<h3>代理模型权限<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>代理模型是从某个模型继承来的，不影响表结构，用于扩展行为实现代码解耦。</p>
</div></blockquote>
<p>代理模型不会继承父类的权限，例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">permissions</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;can_eat_pizzas&#39;</span><span class="p">,</span> <span class="s1">&#39;Can eat pizzas&#39;</span><span class="p">)]</span>

<span class="c1"># 代理模型</span>
<span class="k">class</span> <span class="nc">Student</span><span class="p">(</span><span class="n">Person</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">permissions</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;can_deliver_pizzas&#39;</span><span class="p">,</span> <span class="s1">&#39;Can deliver pizzas&#39;</span><span class="p">)]</span>

<span class="o">&gt;&gt;&gt;</span> <span class="c1"># 注意代理模型取ContentType需要加for_concrete_model=False</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">content_type</span> <span class="o">=</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_for_model</span><span class="p">(</span><span class="n">Student</span><span class="p">,</span> <span class="n">for_concrete_model</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">student_permissions</span> <span class="o">=</span> <span class="n">Permission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="n">content_type</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">codename</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">student_permissions</span><span class="p">]</span>
<span class="p">[</span><span class="s1">&#39;add_student&#39;</span><span class="p">,</span> <span class="s1">&#39;change_student&#39;</span><span class="p">,</span> <span class="s1">&#39;delete_student&#39;</span><span class="p">,</span> <span class="s1">&#39;view_student&#39;</span><span class="p">,</span>
<span class="s1">&#39;can_deliver_pizzas&#39;</span><span class="p">]</span>  <span class="c1"># 没有父类的can_eat_pizzas权限</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="session">
<h2>Session认证<a class="headerlink" href="#session" title="Permalink to this headline">¶</a></h2>
<p>Django认证系统是基于Session的。Django把Web请求封装成了request（HttpRequest类），然后通过中间件设置了session相关的属性：request.session、request.site、request.user。其中request.user就代表当前用户，如果未登陆它的值是AnonymousUser（匿名用户）的实例，如果已登陆它的值是User的实例。可以通过is_authenticated来判断是否已认证：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
    <span class="c1"># Do something for authenticated users.</span>
    <span class="o">...</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Do something for anonymous users.</span>
    <span class="o">...</span>
</pre></div>
</div>
<div class="section" id="id14">
<h3>用户登录<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h3>
<p>我们先简单回顾一下基于session的登录过程：</p>
<p><img alt="image10" src="../_images/image-20201210221059694.png" /></p>
<p>Django提供了<code class="docutils literal notranslate"><span class="pre">login()</span></code>函数来登录，把用户凭证保存到session中。它的函数签名如下：</p>
<p><code class="docutils literal notranslate"><span class="pre">login(request,</span> <span class="pre">user,</span> <span class="pre">backend=None)</span></code></p>
<p>示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">authenticate</span><span class="p">,</span> <span class="n">login</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>


<span class="c1"># Create your views here.</span>


<span class="k">def</span> <span class="nf">my_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request_body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">request_body</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">request_body</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">]</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">login</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;logged in&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;invalid login&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>除了保存用户凭证，Django还会把认证后端也保存到session中，便于相同的认证后端下次可以直接获取到用户信息。至于保存哪个认证后端，Django按以下顺序选取：</p>
<ol class="arabic simple">
<li><p>使用<code class="docutils literal notranslate"><span class="pre">login()</span></code>函数的backend参数值，如果赋值了的话。</p></li>
<li><p>使用user.backend的值，如果有的话。</p></li>
<li><p>使用settings中<code class="docutils literal notranslate"><span class="pre">AUTHENTICATION_BACKENDS</span></code>的值，默认
<code class="docutils literal notranslate"><span class="pre">['django.contrib.auth.backends.ModelBackend']</span></code>。</p></li>
<li><p>否则抛出异常。</p></li>
</ol>
</div>
<div class="section" id="id15">
<h3>用户登出<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h3>
<p>Django提供了<code class="docutils literal notranslate"><span class="pre">logout()</span></code>函数来登出。它的函数签名如下：</p>
<p><code class="docutils literal notranslate"><span class="pre">logout(request)</span></code></p>
<p>示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">logout</span>

<span class="k">def</span> <span class="nf">logout_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">logout</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="c1"># Redirect to a success page.</span>
</pre></div>
</div>
<p>登出后session会被销毁，所有数据都会被清除，以防止其他人使用相同的浏览器再次登录后获取到之前用户的session数据。</p>
</div>
<div class="section" id="login-required">
<h3>login_required<a class="headerlink" href="#login-required" title="Permalink to this headline">¶</a></h3>
<p>对于未登陆的用户，需要进行限制，必须先登陆才能进行访问。</p>
<p><strong>传统方法</strong></p>
<p>使用request.user.is_authenticated判断，然后重定向到登录页面：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">redirect</span>

<span class="k">def</span> <span class="nf">my_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">?next=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LOGIN_URL</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
<p>或者错误页面：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>

<span class="k">def</span> <span class="nf">my_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;myapp/login_error.html&#39;</span><span class="p">)</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
<p><strong>login_required装饰器</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">login_required(redirect_field_name='next',</span> <span class="pre">login_url=None)</span></code></p>
<p>示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="kn">import</span> <span class="n">login_required</span>

<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">my_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>它的处理是这样的：</p>
<ul class="simple">
<li><p>如果用户没有登录，就重定向到settings.LOGIN_URL（默认值<code class="docutils literal notranslate"><span class="pre">/accounts/login/</span></code>），同时把当前的绝对路径添加到查询字符串中，如：<code class="docutils literal notranslate"><span class="pre">/accounts/login/?next=/polls/3/</span></code>。</p></li>
<li><p>如果用户已经登录了，正常执行view代码。</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">login_required</span></code>的<code class="docutils literal notranslate"><span class="pre">redirect_field_name</span></code>参数是指登陆认证成功后重定向的页面，默认保存在叫做<code class="docutils literal notranslate"><span class="pre">next</span></code>的查询字符串参数中（如/accounts/login/?next=/polls/3/）。可以修改为自定义：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="kn">import</span> <span class="n">login_required</span>

<span class="nd">@login_required</span><span class="p">(</span><span class="n">redirect_field_name</span><span class="o">=</span><span class="s1">&#39;my_redirect_field&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>不过修改后还需要同时修改login模板等。</p>
<p><code class="docutils literal notranslate"><span class="pre">login_required</span></code>的<code class="docutils literal notranslate"><span class="pre">login_url</span></code>参数是指登录页面的url，可以自定义，默认是<code class="docutils literal notranslate"><span class="pre">/accounts/login/</span></code>，需要在URLconf中关联登陆视图：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">views</span> <span class="k">as</span> <span class="n">auth_views</span>

<span class="n">path</span><span class="p">(</span><span class="s1">&#39;accounts/login/&#39;</span><span class="p">,</span> <span class="n">auth_views</span><span class="o">.</span><span class="n">LoginView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</pre></div>
</div>
</div>
<div class="section" id="function-viewsclass-based-views">
<h3><strong>function views和class-based views</strong><a class="headerlink" href="#function-viewsclass-based-views" title="Permalink to this headline">¶</a></h3>
<p>function views（函数视图），视图是个函数：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>

<span class="k">def</span> <span class="nf">my_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
        <span class="c1"># &lt;view logic&gt;</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>class-based views（基于类的视图），视图是个类：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.views</span> <span class="kn">import</span> <span class="n">View</span>

<span class="k">class</span> <span class="nc">MyView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c1"># &lt;view logic&gt;</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>为什么需要cbv？因为类可以继承，提高代码复用。由于Django的URLconf只能接受函数，所以cbv有个as_view()方法用来返回一个函数：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># urls.py</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">myapp.views</span> <span class="kn">import</span> <span class="n">MyView</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;about/&#39;</span><span class="p">,</span> <span class="n">MyView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="loginrequiredmixin">
<h3>LoginRequiredMixin<a class="headerlink" href="#loginrequiredmixin" title="Permalink to this headline">¶</a></h3>
<p>Mixin是为了代码复用，从多个父类继承而来的类。如果使用的是class-based
views，那么可以使用LoginRequiredMixin，来实现login_required的效果，例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.contrib.auth.mixins</span> <span class="kn">import</span> <span class="n">LoginRequiredMixin</span>

<span class="k">class</span> <span class="nc">MyView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>
    <span class="n">login_url</span> <span class="o">=</span> <span class="s1">&#39;/login/&#39;</span>
    <span class="n">redirect_field_name</span> <span class="o">=</span> <span class="s1">&#39;redirect_to&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="permission-required">
<h3>permission_required<a class="headerlink" href="#permission-required" title="Permalink to this headline">¶</a></h3>
<p>除了需要登录，有些视图还需要权限。Django提供了<code class="docutils literal notranslate"><span class="pre">permission_required</span></code>装饰器，它的函数签名如下：</p>
<p><code class="docutils literal notranslate"><span class="pre">permission_required(perm,</span> <span class="pre">login_url=None,</span> <span class="pre">raise_exception=False)</span></code></p>
<p>示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="kn">import</span> <span class="n">permission_required</span>

<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;polls.add_choice&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">permission_required</span></code>的<code class="docutils literal notranslate"><span class="pre">perm</span></code>参数，指的是权限，可以是单个权限，也可以是权限列表。</p>
<p><code class="docutils literal notranslate"><span class="pre">permission_required</span></code>的<code class="docutils literal notranslate"><span class="pre">login_url</span></code>参数和<code class="docutils literal notranslate"><span class="pre">login_required</span></code>的<code class="docutils literal notranslate"><span class="pre">login_url</span></code>作用一样。</p>
<p><code class="docutils literal notranslate"><span class="pre">permission_required</span></code>的<code class="docutils literal notranslate"><span class="pre">raise_exception</span></code>参数，可以用来抛出异常，赋值为True后会跳转到403（HTTP
Forbidden）页面而非登录页面。</p>
<p>如果既想抛出异常 ，又想跳转到登录页面，那么可以同时添加这2个装饰器：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="kn">import</span> <span class="n">login_required</span><span class="p">,</span> <span class="n">permission_required</span>

<span class="nd">@login_required</span>
<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;polls.add_choice&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="permissionrequiredmixin">
<h3>PermissionRequiredMixin<a class="headerlink" href="#permissionrequiredmixin" title="Permalink to this headline">¶</a></h3>
<p>如果使用的是class-based
views，那么可以使用PermissionRequiredMixin，来实现permission_required的效果，例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.contrib.auth.mixins</span> <span class="kn">import</span> <span class="n">PermissionRequiredMixin</span>

<span class="k">class</span> <span class="nc">MyView</span><span class="p">(</span><span class="n">PermissionRequiredMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>
    <span class="n">permission_required</span> <span class="o">=</span> <span class="s1">&#39;polls.add_choice&#39;</span>
    <span class="c1"># Or multiple of permissions:</span>
    <span class="n">permission_required</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;polls.view_choice&#39;</span><span class="p">,</span> <span class="s1">&#39;polls.change_choice&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id16">
<h3>修改密码导致session失效<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h3>
<p>登录成功后，Django会把加密后的密码hash值存入session中，每次请求时，会校验session中的密码和数据库中的密码是否匹配。如果修改了密码，数据库中的密码改变了，而session中的密码没有更新，那么密码就会匹配不上，导致session失效。django.contrib.auth的PasswordChangeView和user_change_password视图会在修改密码时更新session中的密码hash，来避免session失效。如果对修改密码的视图进行了自定义，那么可以使用<code class="docutils literal notranslate"><span class="pre">update_session_auth_hash(request,</span> <span class="pre">user)</span></code>来更新session中的密码，防止修改密码导致session失效。</p>
</div>
<div class="section" id="id17">
<h3>认证视图<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h3>
<p>Django提供了登录、登出、密码管理等视图。最简单的使用方式是在URLconf中配置：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;accounts/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;django.contrib.auth.urls&#39;</span><span class="p">)),</span>
<span class="p">]</span>
</pre></div>
</div>
<p>它会包含这些URL patterns：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">accounts</span><span class="o">/</span><span class="n">login</span><span class="o">/</span> <span class="p">[</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;login&#39;</span><span class="p">]</span>
<span class="n">accounts</span><span class="o">/</span><span class="n">logout</span><span class="o">/</span> <span class="p">[</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;logout&#39;</span><span class="p">]</span>
<span class="n">accounts</span><span class="o">/</span><span class="n">password_change</span><span class="o">/</span> <span class="p">[</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;password_change&#39;</span><span class="p">]</span>
<span class="n">accounts</span><span class="o">/</span><span class="n">password_change</span><span class="o">/</span><span class="n">done</span><span class="o">/</span> <span class="p">[</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;password_change_done&#39;</span><span class="p">]</span>
<span class="n">accounts</span><span class="o">/</span><span class="n">password_reset</span><span class="o">/</span> <span class="p">[</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;password_reset&#39;</span><span class="p">]</span>
<span class="n">accounts</span><span class="o">/</span><span class="n">password_reset</span><span class="o">/</span><span class="n">done</span><span class="o">/</span> <span class="p">[</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;password_reset_done&#39;</span><span class="p">]</span>
<span class="n">accounts</span><span class="o">/</span><span class="n">reset</span><span class="o">/&lt;</span><span class="n">uidb64</span><span class="o">&gt;/&lt;</span><span class="n">token</span><span class="o">&gt;/</span> <span class="p">[</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;password_reset_confirm&#39;</span><span class="p">]</span>
<span class="n">accounts</span><span class="o">/</span><span class="n">reset</span><span class="o">/</span><span class="n">done</span><span class="o">/</span> <span class="p">[</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;password_reset_complete&#39;</span><span class="p">]</span>
</pre></div>
</div>
<blockquote>
<div><p>name是别名，可以使用reverse()函数来获取，如<code class="docutils literal notranslate"><span class="pre">reverse('login')</span></code>。</p>
</div></blockquote>
<p>但有时我们需要自定义url，在URLconf中添加自定义url后，再加上相应视图即可，例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">views</span> <span class="k">as</span> <span class="n">auth_views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;change-password/&#39;</span><span class="p">,</span> <span class="n">auth_views</span><span class="o">.</span><span class="n">PasswordChangeView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
<span class="p">]</span>
</pre></div>
</div>
<blockquote>
<div><p>所有的这些视图都是class-based views，便于继承后重写进行自定义。</p>
</div></blockquote>
<p>Django提供的相关视图有LoginView、LogoutView、PasswordChangeView、PasswordChangeDoneView、PasswordResetView、PasswordResetDoneView、PasswordResetConfirmView、PasswordResetCompleteView。</p>
</div>
</div>
<div class="section" id="id18">
<h2>快速上手体验<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h2>
<p>如果想快速上手体验，可以按如下步骤进行操作：</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">django</span></code>，安装Django。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">django-admin</span> <span class="pre">startproject</span> <span class="pre">project_name</span></code>，创建Django项目。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">migrate</span></code>，数据迁移，使用自带SQLite数据库即可。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">createsuperuser</span></code>，创建超级管理员。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">runserver</span></code>，启动项目。</p></li>
<li><p>访问<code class="docutils literal notranslate"><span class="pre">http://127.0.0.1:8000/admin/</span></code>，用超管登录管理后台。</p></li>
</ol>
<p>就可以使用Django自带认证系统了。</p>
</div>
<div class="section" id="id19">
<h2>小结<a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h2>
<p>本文介绍了Django自带的基于session的认证系统，阐述了用户、组、认证与授权的相关概念，以及session认证的技术细节，最后讲解了如何快速上手体验的操作步骤。虽然如今基于session认证用的很少了，但它却是理解Token、JWT认证的基础，仍然值得我们学习。</p>
<blockquote>
<div><p>参考资料：</p>
<p><a class="reference external" href="https://docs.djangoproject.com/en/3.1/topics/auth/">https://docs.djangoproject.com/en/3.1/topics/auth/</a></p>
<p><a class="reference external" href="https://docs.djangoproject.com/en/3.1/topics/auth/default/">https://docs.djangoproject.com/en/3.1/topics/auth/default/</a></p>
</div></blockquote>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="005-%E8%87%AA%E5%AE%9A%E4%B9%89Django%E8%AE%A4%E8%AF%81%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88.html" class="btn btn-neutral float-right" title="5 自定义Django认证系统的技术方案" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="003-Django%E5%AE%98%E6%96%B9%E4%B8%BA%E4%BB%80%E4%B9%88%E6%B2%A1%E6%9C%89%E6%A0%87%E5%87%86%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84.html" class="btn btn-neutral float-left" title="3 Django官方为什么没有标准项目结构" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright dongfanger

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>